{% extends "base.html" %}
{% block title %}Reportes | Invagro{% endblock %}
{% block body_class %}page dashboard-page{% endblock %}
{% block content %}
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="/static/assets/logo.jpg" alt="Invagro" />
        <h3>Invagro</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard">Dashboard</a>
        <a class="nav-item" href="/facturacion">Facturacion</a>
        <a class="nav-item" href="/facturas/credito">Facturas credito</a>
        <a class="nav-item" href="/facturas/historial">Historial facturas</a>
        <a class="nav-item" href="/clientes">Clientes</a>
        <a class="nav-item" href="/productos">Productos</a>
        <a class="nav-item active" href="/reportes">Reportes</a>
        <a class="nav-item" href="/ajustes">Ajustes</a>
      </nav>
      <div class="sidebar-footer">
        <img class="sidebar-mascot" src="/static/assets/mascota.jpeg" alt="Mascota" />
      </div>
    </aside>

    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <h2>Reportes</h2>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Sesion: {{ user }}</span>
        </div>
      </div>

      <main class="content-area">
        <section class="module-header">
          <div>
            <h1>Indicadores y analisis</h1>
            <p>Consolida reportes de ventas, clientes y productos.</p>
          </div>
          <button class="primary-button">Exportar</button>
        </section>

        <section class="report-tools">
          <button class="tool-card" type="button" data-account-open>
            <div class="tool-icon tool-green">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  d="M4 5.5h16c.83 0 1.5.67 1.5 1.5v10c0 .83-.67 1.5-1.5 1.5H4c-.83 0-1.5-.67-1.5-1.5V7c0-.83.67-1.5 1.5-1.5zm0 2.5v.45l7.2 4.32c.5.3 1.1.3 1.6 0L20 8.45V8H4zm16 9.5V10.1l-6.6 3.95c-.9.55-2 .55-2.9 0L4 10.1v7.4h16z"
                />
              </svg>
            </div>
            <h3>Estados de cuenta</h3>
            <p>Selecciona un cliente, revisa facturas pendientes y genera el PDF.</p>
            <span class="tool-action">Abrir →</span>
          </button>
          <button class="tool-card" type="button" data-top-open>
            <div class="tool-icon tool-blue">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M5 3h2v18H5V3zm6 6h2v12h-2V9zm6-4h2v16h-2V5z" />
              </svg>
            </div>
            <h3>Top productos</h3>
            <p>Filtra por fechas y revisa los productos mas vendidos.</p>
            <span class="tool-action">Abrir →</span>
          </button>
          <button class="tool-card" type="button" data-client-open>
            <div class="tool-icon tool-amber">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  d="M7.5 12.5c-2 0-3.5-1.6-3.5-3.6S5.5 5.3 7.5 5.3s3.5 1.6 3.5 3.6-1.5 3.6-3.5 3.6zm9 0c-2 0-3.5-1.6-3.5-3.6S14.5 5.3 16.5 5.3 20 6.9 20 8.9s-1.5 3.6-3.5 3.6zM4 18.7c0-2.3 2.7-4.2 6-4.2s6 1.9 6 4.2V20H4v-1.3z"
                />
              </svg>
            </div>
            <h3>Compras por cliente</h3>
            <p>Consulta historial y totales por cliente en un rango.</p>
            <span class="tool-action">Abrir →</span>
          </button>
          <button class="tool-card" type="button" data-product-open>
            <div class="tool-icon tool-purple">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  d="M4 7l8-4 8 4v10l-8 4-8-4V7zm8 2.2L6.5 7 12 4.8 17.5 7 12 9.2zm-6 1.5v5.6l5 2.5v-5.6l-5-2.5zm7 7.9 5-2.5v-5.6l-5 2.5v5.6z"
                />
              </svg>
            </div>
            <h3>Productos por cliente</h3>
            <p>Lista de productos comprados por cliente y total.</p>
            <span class="tool-action">Abrir →</span>
          </button>
        </section>
      </main>
    </div>
  </div>

  <div class="modal" id="account-modal">
    <div class="modal-card account-modal-card">
      <div class="modal-header">
        <div>
          <h3>Estado de cuenta</h3>
          <span id="account-client-label">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-account-close>×</button>
      </div>
      <div class="account-modal-body">
        <div class="account-form">
          <label>
            <span>Cliente</span>
            <select id="account-client-select">
              <option value="">Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>RTN</span>
            <input type="text" id="account-rtn" placeholder="RTN" readonly />
          </label>
          <label>
            <span>Telefono WhatsApp</span>
            <input type="tel" id="account-phone" placeholder="Ej. 50499999999" />
          </label>
        </div>
        <div class="account-invoice-table">
          <div class="account-invoice-header">
            <span>Factura</span>
            <span>Fecha</span>
            <span>Total</span>
            <span>Saldo</span>
          </div>
          <div class="account-invoice-body" id="account-invoice-body">
            <div class="account-invoice-row is-empty">
              Selecciona un cliente para ver facturas pendientes.
            </div>
          </div>
        </div>
        <div class="account-summary">
          <div>
            <span>Total pendiente</span>
            <strong id="account-total-label">L 0.00</strong>
          </div>
          <div>
            <span>Facturas pendientes</span>
            <strong id="account-count-label">0</strong>
          </div>
        </div>
        <p class="account-note">
          Genera el PDF y luego envialo por WhatsApp con el enlace.
        </p>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-account-close>Cancelar</button>
        <button class="primary-button" type="button" id="account-print">Generar PDF</button>
        <button class="secondary-button" type="button" id="account-whatsapp">Enviar PDF</button>
      </div>
    </div>
  </div>

  <div class="modal" id="top-modal">
    <div class="modal-card report-modal-card">
      <div class="modal-header">
        <div>
          <h3>Top productos vendidos</h3>
          <span id="top-range-label">Rango: -</span>
        </div>
        <button class="modal-close" type="button" data-top-close>×</button>
      </div>
      <div class="report-modal-body">
        <div class="report-form">
          <label>
            <span>Desde</span>
            <input type="date" id="top-start" />
          </label>
          <label>
            <span>Hasta</span>
            <input type="date" id="top-end" />
          </label>
          <button class="primary-button" type="button" id="top-search">Buscar</button>
        </div>
        <div class="report-table">
          <div class="report-table-header">
            <span>Producto</span>
            <span>Unidades</span>
            <span>Total</span>
          </div>
          <div class="report-table-body" id="top-table-body">
            <div class="report-table-row is-empty">Selecciona un rango de fechas.</div>
          </div>
        </div>
        <div class="report-summary">
          <div>
            <span>Total vendido</span>
            <strong id="top-total-label">L 0.00</strong>
          </div>
          <div>
            <span>Productos listados</span>
            <strong id="top-count-label">0</strong>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-top-close>Cerrar</button>
        <button class="primary-button" type="button" id="top-pdf">Generar PDF</button>
        <button class="secondary-button" type="button" id="top-whatsapp">Enviar PDF</button>
      </div>
    </div>
  </div>

  <div class="modal" id="client-modal">
    <div class="modal-card report-modal-card">
      <div class="modal-header">
        <div>
          <h3>Compras por cliente</h3>
          <span id="client-range-label">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-client-close>×</button>
      </div>
        <div class="report-modal-body">
          <div class="report-form report-form-wide">
            <label>
              <span>Cliente</span>
            <select id="client-select">
              <option value="">Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
              {% endfor %}
            </select>
          </label>
            <label>
              <span>Desde</span>
              <input type="date" id="client-start" />
            </label>
            <label>
              <span>Hasta</span>
              <input type="date" id="client-end" />
            </label>
            <label>
              <span>Telefono WhatsApp</span>
              <input type="tel" id="client-phone" placeholder="Ej. 50499999999" />
            </label>
            <button class="primary-button" type="button" id="client-search">Buscar</button>
          </div>
        <div class="report-table report-table-wide">
          <div class="report-table-header report-table-header-wide">
            <span>Factura</span>
            <span>Fecha</span>
            <span>Estado</span>
            <span>Total</span>
          </div>
          <div class="report-table-body" id="client-table-body">
            <div class="report-table-row is-empty">Selecciona un cliente para iniciar.</div>
          </div>
        </div>
        <div class="report-summary">
          <div>
            <span>Total comprado</span>
            <strong id="client-total-label">L 0.00</strong>
          </div>
          <div>
            <span>Facturas listadas</span>
            <strong id="client-count-label">0</strong>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-client-close>Cerrar</button>
        <button class="primary-button" type="button" id="client-pdf">Generar PDF</button>
        <button class="secondary-button" type="button" id="client-whatsapp">Enviar PDF</button>
      </div>
    </div>
  </div>

  <div class="modal" id="product-modal">
    <div class="modal-card report-modal-card">
      <div class="modal-header">
        <div>
          <h3>Productos comprados</h3>
          <span id="product-range-label">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-product-close>×</button>
      </div>
      <div class="report-modal-body">
        <div class="report-form report-form-wide">
          <label>
            <span>Cliente</span>
            <select id="product-client-select">
              <option value="">Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>Desde</span>
            <input type="date" id="product-start" />
          </label>
          <label>
            <span>Hasta</span>
            <input type="date" id="product-end" />
          </label>
          <label>
            <span>Telefono WhatsApp</span>
            <input type="tel" id="product-phone" placeholder="Ej. 50499999999" />
          </label>
          <button class="primary-button" type="button" id="product-search">Buscar</button>
        </div>
        <div class="report-table">
          <div class="report-table-header">
            <span>Producto</span>
            <span>Unidades</span>
            <span>Total</span>
          </div>
          <div class="report-table-body" id="product-table-body">
            <div class="report-table-row is-empty">Selecciona un cliente para iniciar.</div>
          </div>
        </div>
        <div class="report-summary">
          <div>
            <span>Total comprado</span>
            <strong id="product-total-label">L 0.00</strong>
          </div>
          <div>
            <span>Productos listados</span>
            <strong id="product-count-label">0</strong>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-product-close>Cerrar</button>
        <button class="primary-button" type="button" id="product-pdf">Generar PDF</button>
        <button class="secondary-button" type="button" id="product-whatsapp">Enviar PDF</button>
      </div>
    </div>
  </div>

  <div id="account-pdf" class="account-pdf">
    <div class="account-pdf-header">
      <img src="/static/assets/logo.jpg" alt="Logo Invagro" />
      <div>
        <h2>Estado de cuenta</h2>
        <span id="pdf-date">Fecha: -</span>
      </div>
    </div>
    <div class="account-pdf-meta">
      <div>
        <span>Cliente</span>
        <strong id="pdf-client">-</strong>
      </div>
      <div>
        <span>RTN</span>
        <strong id="pdf-rtn">-</strong>
      </div>
      <div>
        <span>Telefono</span>
        <strong id="pdf-phone">-</strong>
      </div>
    </div>
    <div class="account-pdf-table">
      <div class="account-pdf-row account-pdf-header-row">
        <span>Factura</span>
        <span>Fecha</span>
        <span>Total</span>
        <span>Saldo</span>
      </div>
      <div class="account-pdf-body" id="account-pdf-body"></div>
    </div>
    <div class="account-pdf-summary">
      <div>
        <span>Total pendiente</span>
        <strong id="pdf-total">L 0.00</strong>
      </div>
      <div>
        <span>Facturas pendientes</span>
        <strong id="pdf-count">0</strong>
      </div>
    </div>
    <p class="account-pdf-note">
      Este resumen corresponde a los saldos pendientes del cliente.
    </p>
  </div>

  <script>
    const accountModal = document.getElementById("account-modal");
    const accountOpenButtons = document.querySelectorAll("[data-account-open]");
    const accountCloseButtons = document.querySelectorAll("[data-account-close]");
    const accountClientSelect = document.getElementById("account-client-select");
    const accountRtnInput = document.getElementById("account-rtn");
    const accountPhoneInput = document.getElementById("account-phone");
    const accountClientLabel = document.getElementById("account-client-label");
    const accountTotalLabel = document.getElementById("account-total-label");
    const accountCountLabel = document.getElementById("account-count-label");
    const accountInvoiceBody = document.getElementById("account-invoice-body");
    const accountPrintButton = document.getElementById("account-print");
    const accountWhatsappButton = document.getElementById("account-whatsapp");
    const pdfClient = document.getElementById("pdf-client");
    const pdfRtn = document.getElementById("pdf-rtn");
    const pdfPhone = document.getElementById("pdf-phone");
    const pdfTotal = document.getElementById("pdf-total");
    const pdfCount = document.getElementById("pdf-count");
    const pdfDate = document.getElementById("pdf-date");
    const accountPdfBody = document.getElementById("account-pdf-body");
    const clientes = {{ clientes | tojson }};
    const facturasCredito = {{ facturas_credito | tojson }};
    let currentPdfUrl = "";
    const topModal = document.getElementById("top-modal");
    const topOpenButtons = document.querySelectorAll("[data-top-open]");
    const topCloseButtons = document.querySelectorAll("[data-top-close]");
    const topStartInput = document.getElementById("top-start");
    const topEndInput = document.getElementById("top-end");
    const topSearchButton = document.getElementById("top-search");
    const topTableBody = document.getElementById("top-table-body");
    const topTotalLabel = document.getElementById("top-total-label");
    const topCountLabel = document.getElementById("top-count-label");
    const topRangeLabel = document.getElementById("top-range-label");
    const topPdfButton = document.getElementById("top-pdf");
    const topWhatsappButton = document.getElementById("top-whatsapp");
    const clientModal = document.getElementById("client-modal");
    const clientOpenButtons = document.querySelectorAll("[data-client-open]");
    const clientCloseButtons = document.querySelectorAll("[data-client-close]");
    const clientSelect = document.getElementById("client-select");
    const clientStartInput = document.getElementById("client-start");
    const clientEndInput = document.getElementById("client-end");
    const clientPhoneInput = document.getElementById("client-phone");
    const clientSearchButton = document.getElementById("client-search");
    const clientPdfButton = document.getElementById("client-pdf");
    const clientWhatsappButton = document.getElementById("client-whatsapp");
    const clientTableBody = document.getElementById("client-table-body");
    const clientTotalLabel = document.getElementById("client-total-label");
    const clientCountLabel = document.getElementById("client-count-label");
    const clientRangeLabel = document.getElementById("client-range-label");
    const productModal = document.getElementById("product-modal");
    const productOpenButtons = document.querySelectorAll("[data-product-open]");
    const productCloseButtons = document.querySelectorAll("[data-product-close]");
    const productClientSelect = document.getElementById("product-client-select");
    const productStartInput = document.getElementById("product-start");
    const productEndInput = document.getElementById("product-end");
    const productPhoneInput = document.getElementById("product-phone");
    const productSearchButton = document.getElementById("product-search");
    const productPdfButton = document.getElementById("product-pdf");
    const productWhatsappButton = document.getElementById("product-whatsapp");
    const productTableBody = document.getElementById("product-table-body");
    const productTotalLabel = document.getElementById("product-total-label");
    const productCountLabel = document.getElementById("product-count-label");
    const productRangeLabel = document.getElementById("product-range-label");
    let currentProductPdfUrl = "";
    let currentTopPdfUrl = "";
    let currentClientPdfUrl = "";

    const currencyFormatter = new Intl.NumberFormat("es-HN", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

    const formatCurrency = (value) => `L ${currencyFormatter.format(value || 0)}`;
    const toDateInputValue = (date) => {
      const offset = date.getTimezoneOffset() * 60000;
      return new Date(date.getTime() - offset).toISOString().slice(0, 10);
    };
    const formatRangeLabel = (startValue, endValue) => {
      if (!startValue || !endValue) {
        return "-";
      }
      return `${startValue} a ${endValue}`;
    };

    const renderEmptyInvoices = (message) => {
      accountInvoiceBody.innerHTML = "";
      accountPdfBody.innerHTML = "";
      const row = document.createElement("div");
      row.className = "account-invoice-row is-empty";
      row.textContent = message;
      accountInvoiceBody.appendChild(row);
    };

    const updatePdfMeta = (client, totalSaldo, invoiceCount) => {
      const formattedTotal = formatCurrency(totalSaldo);
      const today = new Date();
      const formattedDate = today.toLocaleDateString("es-HN", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });

      pdfClient.textContent = client?.nombre || "-";
      pdfRtn.textContent = client?.rtn || "-";
      pdfPhone.textContent = client?.telefono || "-";
      pdfTotal.textContent = formattedTotal;
      pdfCount.textContent = `${invoiceCount}`;
      pdfDate.textContent = `Fecha: ${formattedDate}`;
    };

    const renderInvoicesForClient = (clientId) => {
      const client = clientes.find((item) => String(item.id) === String(clientId));
      accountRtnInput.value = client?.rtn || "";
      accountPhoneInput.value = client?.telefono || "";
      accountClientLabel.textContent = `Cliente: ${client?.nombre || "-"}`;
      currentPdfUrl = "";

      if (!clientId) {
        accountTotalLabel.textContent = formatCurrency(0);
        accountCountLabel.textContent = "0";
        updatePdfMeta(null, 0, 0);
        renderEmptyInvoices("Selecciona un cliente para ver facturas pendientes.");
        return;
      }

      const invoices = facturasCredito.filter(
        (factura) => String(factura.cliente_id) === String(clientId)
      );
      let totalSaldo = 0;
      accountInvoiceBody.innerHTML = "";
      accountPdfBody.innerHTML = "";

      if (!invoices.length) {
        accountTotalLabel.textContent = formatCurrency(0);
        accountCountLabel.textContent = "0";
        updatePdfMeta(client, 0, 0);
        renderEmptyInvoices("No hay facturas pendientes para este cliente.");
        return;
      }

      invoices.forEach((factura) => {
        totalSaldo += factura.saldo || 0;
        const row = document.createElement("div");
        row.className = "account-invoice-row";
        row.innerHTML = `
          <span>${factura.numero_factura}</span>
          <span>${factura.fecha}</span>
          <span>${formatCurrency(factura.total)}</span>
          <span>${formatCurrency(factura.saldo)}</span>
        `;
        accountInvoiceBody.appendChild(row);

        const pdfRow = document.createElement("div");
        pdfRow.className = "account-pdf-row";
        pdfRow.innerHTML = `
          <span>${factura.numero_factura}</span>
          <span>${factura.fecha}</span>
          <span>${formatCurrency(factura.total)}</span>
          <span>${formatCurrency(factura.saldo)}</span>
        `;
        accountPdfBody.appendChild(pdfRow);
      });

      accountTotalLabel.textContent = formatCurrency(totalSaldo);
      accountCountLabel.textContent = `${invoices.length}`;
      updatePdfMeta(client, totalSaldo, invoices.length);
    };

    const openAccountModal = () => {
      accountClientSelect.value = "";
      renderInvoicesForClient("");
      accountModal.classList.add("open");
    };

    accountOpenButtons.forEach((button) => {
      button.addEventListener("click", () => openAccountModal());
    });

    accountCloseButtons.forEach((button) => {
      button.addEventListener("click", () => accountModal.classList.remove("open"));
    });

    accountClientSelect.addEventListener("change", (event) => {
      renderInvoicesForClient(event.target.value);
    });

    accountPhoneInput.addEventListener("input", () => {
      pdfPhone.textContent = accountPhoneInput.value.trim() || "-";
    });

    accountPrintButton.addEventListener("click", async () => {
      const clientId = accountClientSelect.value;
      if (!clientId) {
        alert("Selecciona un cliente para generar el PDF.");
        return;
      }
      try {
        const response = await fetch("/reportes/estado-cuenta/pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cliente_id: clientId }),
        });
        if (!response.ok) {
          throw new Error("No se pudo generar el PDF.");
        }
        const result = await response.json();
        currentPdfUrl = result.pdf_url || "";
        if (currentPdfUrl) {
          window.open(currentPdfUrl, "_blank");
        }
      } catch (error) {
        alert("No se pudo generar el PDF.");
      }
    });

    accountWhatsappButton.addEventListener("click", () => {
      const phone = accountPhoneInput.value.replace(/\\D/g, "");
      if (!phone) {
        alert("Ingresa un telefono de WhatsApp para continuar.");
        return;
      }
      if (!currentPdfUrl) {
        alert("Primero genera el PDF para poder enviarlo.");
        return;
      }
      const client = accountClientSelect.options[accountClientSelect.selectedIndex]?.text || "";
      const message = encodeURIComponent(
        `Hola ${client}. Te envio el estado de cuenta. PDF: ${currentPdfUrl}`
      );
      window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
    });

    const renderTopEmpty = (message) => {
      topTableBody.innerHTML = "";
      const row = document.createElement("div");
      row.className = "report-table-row is-empty";
      row.textContent = message;
      topTableBody.appendChild(row);
    };

    const renderClientEmpty = (message) => {
      clientTableBody.innerHTML = "";
      const row = document.createElement("div");
      row.className = "report-table-row is-empty";
      row.textContent = message;
      clientTableBody.appendChild(row);
    };

    const renderProductEmpty = (message) => {
      productTableBody.innerHTML = "";
      const row = document.createElement("div");
      row.className = "report-table-row is-empty";
      row.textContent = message;
      productTableBody.appendChild(row);
    };

    const openTopModal = () => {
      const today = new Date();
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      topStartInput.value = toDateInputValue(startOfMonth);
      topEndInput.value = toDateInputValue(today);
      topRangeLabel.textContent = `Rango: ${formatRangeLabel(topStartInput.value, topEndInput.value)}`;
      currentTopPdfUrl = "";
      renderTopEmpty("Selecciona un rango de fechas.");
      topTotalLabel.textContent = formatCurrency(0);
      topCountLabel.textContent = "0";
      topModal.classList.add("open");
    };

    topOpenButtons.forEach((button) => {
      button.addEventListener("click", openTopModal);
    });
    topCloseButtons.forEach((button) => {
      button.addEventListener("click", () => topModal.classList.remove("open"));
    });
    if (topModal) {
      topModal.addEventListener("click", (event) => {
        if (event.target === topModal) {
          topModal.classList.remove("open");
        }
      });
    }
    if (topSearchButton) {
      topSearchButton.addEventListener("click", async () => {
        const startValue = topStartInput.value;
        const endValue = topEndInput.value;
        if (!startValue || !endValue) {
          renderTopEmpty("Selecciona un rango de fechas.");
          return;
        }
        topRangeLabel.textContent = `Rango: ${formatRangeLabel(startValue, endValue)}`;
        currentTopPdfUrl = "";
        try {
          const response = await fetch("/reportes/productos-top", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start_date: startValue, end_date: endValue }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo cargar.");
          }
          const productos = result.productos || [];
          topTableBody.innerHTML = "";
          if (!productos.length) {
            renderTopEmpty("No hay ventas en el rango seleccionado.");
            topTotalLabel.textContent = formatCurrency(0);
            topCountLabel.textContent = "0";
            return;
          }
          productos.forEach((producto) => {
            const row = document.createElement("div");
            row.className = "report-table-row";
            row.innerHTML = `
              <span>${producto.nombre}</span>
              <span>${producto.cantidad}</span>
              <span>${formatCurrency(producto.total)}</span>
            `;
            topTableBody.appendChild(row);
          });
          topTotalLabel.textContent = formatCurrency(result.total || 0);
          topCountLabel.textContent = `${productos.length}`;
        } catch (error) {
          renderTopEmpty("No se pudo cargar el reporte.");
        }
      });
    }
    if (topPdfButton) {
      topPdfButton.addEventListener("click", async () => {
        const startValue = topStartInput.value;
        const endValue = topEndInput.value;
        if (!startValue || !endValue) {
          alert("Selecciona un rango de fechas.");
          return;
        }
        try {
          const response = await fetch("/reportes/productos-top/pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start_date: startValue, end_date: endValue }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo generar el PDF.");
          }
          currentTopPdfUrl = result.pdf_url || "";
          if (currentTopPdfUrl) {
            window.open(currentTopPdfUrl, "_blank");
          }
        } catch (error) {
          alert("No se pudo generar el PDF.");
        }
      });
    }
    if (topWhatsappButton) {
      topWhatsappButton.addEventListener("click", () => {
        if (!currentTopPdfUrl) {
          alert("Primero genera el PDF para poder enviarlo.");
          return;
        }
        const message = encodeURIComponent(
          `Hola, te envio el reporte de top productos. PDF: ${currentTopPdfUrl}`
        );
        window.open(`https://wa.me/?text=${message}`, "_blank");
      });
    }

    const openClientModal = () => {
      const today = new Date();
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      clientStartInput.value = toDateInputValue(startOfMonth);
      clientEndInput.value = toDateInputValue(today);
      clientSelect.value = "";
      clientPhoneInput.value = "";
      clientRangeLabel.textContent = "Cliente: -";
      currentClientPdfUrl = "";
      renderClientEmpty("Selecciona un cliente para iniciar.");
      clientTotalLabel.textContent = formatCurrency(0);
      clientCountLabel.textContent = "0";
      clientModal.classList.add("open");
    };

    clientOpenButtons.forEach((button) => {
      button.addEventListener("click", openClientModal);
    });
    clientCloseButtons.forEach((button) => {
      button.addEventListener("click", () => clientModal.classList.remove("open"));
    });
    if (clientModal) {
      clientModal.addEventListener("click", (event) => {
        if (event.target === clientModal) {
          clientModal.classList.remove("open");
        }
      });
    }
    if (clientSelect) {
      clientSelect.addEventListener("change", () => {
        const selectedText =
          clientSelect.options[clientSelect.selectedIndex]?.textContent || "-";
        clientRangeLabel.textContent = `Cliente: ${selectedText}`;
        const selectedClient = clientes.find(
          (item) => String(item.id) === String(clientSelect.value)
        );
        clientPhoneInput.value = selectedClient?.telefono || "";
      });
    }
    if (clientSearchButton) {
      clientSearchButton.addEventListener("click", async () => {
        const clienteId = clientSelect.value;
        if (!clienteId) {
          renderClientEmpty("Selecciona un cliente para iniciar.");
          return;
        }
        const startValue = clientStartInput.value;
        const endValue = clientEndInput.value;
        if (!startValue || !endValue) {
          renderClientEmpty("Selecciona un rango de fechas.");
          return;
        }
        const selectedText =
          clientSelect.options[clientSelect.selectedIndex]?.textContent || "-";
        clientRangeLabel.textContent = `Cliente: ${selectedText}`;
        currentClientPdfUrl = "";
        try {
          const response = await fetch("/reportes/compras-cliente", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cliente_id: clienteId,
              start_date: startValue,
              end_date: endValue,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo cargar.");
          }
          const facturas = result.facturas || [];
          clientTableBody.innerHTML = "";
          if (!facturas.length) {
            renderClientEmpty("No hay compras en el rango seleccionado.");
            clientTotalLabel.textContent = formatCurrency(0);
            clientCountLabel.textContent = "0";
            return;
          }
          facturas.forEach((factura) => {
            const row = document.createElement("div");
            row.className = "report-table-row report-table-row-wide";
            row.innerHTML = `
              <span>${factura.numero_factura}</span>
              <span>${factura.fecha}</span>
              <span>${factura.estado}</span>
              <span>${formatCurrency(factura.total)}</span>
            `;
            clientTableBody.appendChild(row);
          });
          clientTotalLabel.textContent = formatCurrency(result.total || 0);
          clientCountLabel.textContent = `${facturas.length}`;
        } catch (error) {
          renderClientEmpty("No se pudo cargar el reporte.");
        }
      });
    }
    if (clientPdfButton) {
      clientPdfButton.addEventListener("click", async () => {
        const clienteId = clientSelect.value;
        if (!clienteId) {
          alert("Selecciona un cliente para generar el PDF.");
          return;
        }
        const startValue = clientStartInput.value;
        const endValue = clientEndInput.value;
        if (!startValue || !endValue) {
          alert("Selecciona un rango de fechas.");
          return;
        }
        try {
          const response = await fetch("/reportes/compras-cliente/pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cliente_id: clienteId,
              start_date: startValue,
              end_date: endValue,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo generar el PDF.");
          }
          currentClientPdfUrl = result.pdf_url || "";
          if (currentClientPdfUrl) {
            window.open(currentClientPdfUrl, "_blank");
          }
        } catch (error) {
          alert("No se pudo generar el PDF.");
        }
      });
    }
    if (clientWhatsappButton) {
      clientWhatsappButton.addEventListener("click", () => {
        const phone = clientPhoneInput.value.replace(/\\D/g, "");
        if (!phone) {
          alert("Ingresa un telefono de WhatsApp para continuar.");
          return;
        }
        if (!currentClientPdfUrl) {
          alert("Primero genera el PDF para poder enviarlo.");
          return;
        }
        const client = clientSelect.options[clientSelect.selectedIndex]?.text || "";
        const message = encodeURIComponent(
          `Hola ${client}. Te envio el reporte de compras. PDF: ${currentClientPdfUrl}`
        );
        window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
      });
    }

    const openProductModal = () => {
      const today = new Date();
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      productStartInput.value = toDateInputValue(startOfMonth);
      productEndInput.value = toDateInputValue(today);
      productClientSelect.value = "";
      productRangeLabel.textContent = "Cliente: -";
      productPhoneInput.value = "";
      currentProductPdfUrl = "";
      renderProductEmpty("Selecciona un cliente para iniciar.");
      productTotalLabel.textContent = formatCurrency(0);
      productCountLabel.textContent = "0";
      productModal.classList.add("open");
    };

    productOpenButtons.forEach((button) => {
      button.addEventListener("click", openProductModal);
    });
    productCloseButtons.forEach((button) => {
      button.addEventListener("click", () => productModal.classList.remove("open"));
    });
    if (productModal) {
      productModal.addEventListener("click", (event) => {
        if (event.target === productModal) {
          productModal.classList.remove("open");
        }
      });
    }
    if (productClientSelect) {
      productClientSelect.addEventListener("change", () => {
        const selectedText =
          productClientSelect.options[productClientSelect.selectedIndex]?.textContent || "-";
        productRangeLabel.textContent = `Cliente: ${selectedText}`;
        const selectedClient = clientes.find(
          (item) => String(item.id) === String(productClientSelect.value)
        );
        productPhoneInput.value = selectedClient?.telefono || "";
      });
    }
    if (productSearchButton) {
      productSearchButton.addEventListener("click", async () => {
        const clienteId = productClientSelect.value;
        if (!clienteId) {
          renderProductEmpty("Selecciona un cliente para iniciar.");
          return;
        }
        const startValue = productStartInput.value;
        const endValue = productEndInput.value;
        if (!startValue || !endValue) {
          renderProductEmpty("Selecciona un rango de fechas.");
          return;
        }
        const selectedText =
          productClientSelect.options[productClientSelect.selectedIndex]?.textContent || "-";
        productRangeLabel.textContent = `Cliente: ${selectedText}`;
        currentProductPdfUrl = "";
        try {
          const response = await fetch("/reportes/productos-cliente", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cliente_id: clienteId,
              start_date: startValue,
              end_date: endValue,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo cargar.");
          }
          const productos = result.productos || [];
          productTableBody.innerHTML = "";
          if (!productos.length) {
            renderProductEmpty("No hay compras en el rango seleccionado.");
            productTotalLabel.textContent = formatCurrency(0);
            productCountLabel.textContent = "0";
            return;
          }
          productos.forEach((producto) => {
            const row = document.createElement("div");
            row.className = "report-table-row";
            row.innerHTML = `
              <span>${producto.nombre}</span>
              <span>${producto.cantidad}</span>
              <span>${formatCurrency(producto.total)}</span>
            `;
            productTableBody.appendChild(row);
          });
          productTotalLabel.textContent = formatCurrency(result.total || 0);
          productCountLabel.textContent = `${productos.length}`;
        } catch (error) {
          renderProductEmpty("No se pudo cargar el reporte.");
        }
      });
    }
    if (productPdfButton) {
      productPdfButton.addEventListener("click", async () => {
        const clienteId = productClientSelect.value;
        if (!clienteId) {
          alert("Selecciona un cliente para generar el PDF.");
          return;
        }
        const startValue = productStartInput.value;
        const endValue = productEndInput.value;
        if (!startValue || !endValue) {
          alert("Selecciona un rango de fechas.");
          return;
        }
        try {
          const response = await fetch("/reportes/productos-cliente/pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cliente_id: clienteId,
              start_date: startValue,
              end_date: endValue,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "No se pudo generar el PDF.");
          }
          currentProductPdfUrl = result.pdf_url || "";
          if (currentProductPdfUrl) {
            window.open(currentProductPdfUrl, "_blank");
          }
        } catch (error) {
          alert("No se pudo generar el PDF.");
        }
      });
    }
    if (productWhatsappButton) {
      productWhatsappButton.addEventListener("click", () => {
        const phone = productPhoneInput.value.replace(/\\D/g, "");
        if (!phone) {
          alert("Ingresa un telefono de WhatsApp para continuar.");
          return;
        }
        if (!currentProductPdfUrl) {
          alert("Primero genera el PDF para poder enviarlo.");
          return;
        }
        const client = productClientSelect.options[productClientSelect.selectedIndex]?.text || "";
        const message = encodeURIComponent(
          `Hola ${client}. Te envio el reporte de productos comprados. PDF: ${currentProductPdfUrl}`
        );
        window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
      });
    }
  </script>
{% endblock %}
