{% extends "base.html" %}
{% block title %}Reportes | Invagro{% endblock %}
{% block body_class %}page dashboard-page{% endblock %}
{% block content %}
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="/static/assets/logo.jpg" alt="Invagro" />
        <h3>Invagro</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard">Dashboard</a>
        <a class="nav-item" href="/facturacion">Facturacion</a>
        <a class="nav-item" href="/facturas/credito">Facturas credito</a>
        <a class="nav-item" href="/facturas/historial">Historial facturas</a>
        <a class="nav-item" href="/clientes">Clientes</a>
        <a class="nav-item" href="/productos">Productos</a>
        <a class="nav-item active" href="/reportes">Reportes</a>
        <a class="nav-item" href="/ajustes">Ajustes</a>
      </nav>
      <div class="sidebar-footer">
        <img class="sidebar-mascot" src="/static/assets/mascota.jpeg" alt="Mascota" />
      </div>
    </aside>

    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <h2>Reportes</h2>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Sesion: {{ user }}</span>
        </div>
      </div>

      <main class="content-area">
        <section class="module-header">
          <div>
            <h1>Indicadores y analisis</h1>
            <p>Consolida reportes de ventas, clientes y productos.</p>
          </div>
          <button class="primary-button">Exportar</button>
        </section>

        <section class="report-tools">
          <button class="tool-card" type="button" data-account-open>
            <div class="tool-icon tool-green">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path
                  d="M4 5.5h16c.83 0 1.5.67 1.5 1.5v10c0 .83-.67 1.5-1.5 1.5H4c-.83 0-1.5-.67-1.5-1.5V7c0-.83.67-1.5 1.5-1.5zm0 2.5v.45l7.2 4.32c.5.3 1.1.3 1.6 0L20 8.45V8H4zm16 9.5V10.1l-6.6 3.95c-.9.55-2 .55-2.9 0L4 10.1v7.4h16z"
                />
              </svg>
            </div>
            <h3>Estados de cuenta</h3>
            <p>Selecciona un cliente, revisa facturas pendientes y genera el PDF.</p>
            <span class="tool-action">Abrir →</span>
          </button>
        </section>
      </main>
    </div>
  </div>

  <div class="modal" id="account-modal">
    <div class="modal-card account-modal-card">
      <div class="modal-header">
        <div>
          <h3>Estado de cuenta</h3>
          <span id="account-client-label">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-account-close>×</button>
      </div>
      <div class="account-modal-body">
        <div class="account-form">
          <label>
            <span>Cliente</span>
            <select id="account-client-select">
              <option value="">Selecciona un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>RTN</span>
            <input type="text" id="account-rtn" placeholder="RTN" readonly />
          </label>
          <label>
            <span>Telefono WhatsApp</span>
            <input type="tel" id="account-phone" placeholder="Ej. 50499999999" />
          </label>
        </div>
        <div class="account-invoice-table">
          <div class="account-invoice-header">
            <span>Factura</span>
            <span>Fecha</span>
            <span>Total</span>
            <span>Saldo</span>
          </div>
          <div class="account-invoice-body" id="account-invoice-body">
            <div class="account-invoice-row is-empty">
              Selecciona un cliente para ver facturas pendientes.
            </div>
          </div>
        </div>
        <div class="account-summary">
          <div>
            <span>Total pendiente</span>
            <strong id="account-total-label">L 0.00</strong>
          </div>
          <div>
            <span>Facturas pendientes</span>
            <strong id="account-count-label">0</strong>
          </div>
        </div>
        <p class="account-note">
          Genera el PDF y luego envialo por WhatsApp con el enlace.
        </p>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-account-close>Cancelar</button>
        <button class="primary-button" type="button" id="account-print">Generar PDF</button>
        <button class="secondary-button" type="button" id="account-whatsapp">Enviar PDF</button>
      </div>
    </div>
  </div>

  <div id="account-pdf" class="account-pdf">
    <div class="account-pdf-header">
      <img src="/static/assets/logo.jpg" alt="Logo Invagro" />
      <div>
        <h2>Estado de cuenta</h2>
        <span id="pdf-date">Fecha: -</span>
      </div>
    </div>
    <div class="account-pdf-meta">
      <div>
        <span>Cliente</span>
        <strong id="pdf-client">-</strong>
      </div>
      <div>
        <span>RTN</span>
        <strong id="pdf-rtn">-</strong>
      </div>
      <div>
        <span>Telefono</span>
        <strong id="pdf-phone">-</strong>
      </div>
    </div>
    <div class="account-pdf-table">
      <div class="account-pdf-row account-pdf-header-row">
        <span>Factura</span>
        <span>Fecha</span>
        <span>Total</span>
        <span>Saldo</span>
      </div>
      <div class="account-pdf-body" id="account-pdf-body"></div>
    </div>
    <div class="account-pdf-summary">
      <div>
        <span>Total pendiente</span>
        <strong id="pdf-total">L 0.00</strong>
      </div>
      <div>
        <span>Facturas pendientes</span>
        <strong id="pdf-count">0</strong>
      </div>
    </div>
    <p class="account-pdf-note">
      Este resumen corresponde a los saldos pendientes del cliente.
    </p>
  </div>

  <script>
    const accountModal = document.getElementById("account-modal");
    const accountOpenButtons = document.querySelectorAll("[data-account-open]");
    const accountCloseButtons = document.querySelectorAll("[data-account-close]");
    const accountClientSelect = document.getElementById("account-client-select");
    const accountRtnInput = document.getElementById("account-rtn");
    const accountPhoneInput = document.getElementById("account-phone");
    const accountClientLabel = document.getElementById("account-client-label");
    const accountTotalLabel = document.getElementById("account-total-label");
    const accountCountLabel = document.getElementById("account-count-label");
    const accountInvoiceBody = document.getElementById("account-invoice-body");
    const accountPrintButton = document.getElementById("account-print");
    const accountWhatsappButton = document.getElementById("account-whatsapp");
    const pdfClient = document.getElementById("pdf-client");
    const pdfRtn = document.getElementById("pdf-rtn");
    const pdfPhone = document.getElementById("pdf-phone");
    const pdfTotal = document.getElementById("pdf-total");
    const pdfCount = document.getElementById("pdf-count");
    const pdfDate = document.getElementById("pdf-date");
    const accountPdfBody = document.getElementById("account-pdf-body");
    const clientes = {{ clientes | tojson }};
    const facturasCredito = {{ facturas_credito | tojson }};
    let currentPdfUrl = "";

    const currencyFormatter = new Intl.NumberFormat("es-HN", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

    const formatCurrency = (value) => `L ${currencyFormatter.format(value || 0)}`;

    const renderEmptyInvoices = (message) => {
      accountInvoiceBody.innerHTML = "";
      accountPdfBody.innerHTML = "";
      const row = document.createElement("div");
      row.className = "account-invoice-row is-empty";
      row.textContent = message;
      accountInvoiceBody.appendChild(row);
    };

    const updatePdfMeta = (client, totalSaldo, invoiceCount) => {
      const formattedTotal = formatCurrency(totalSaldo);
      const today = new Date();
      const formattedDate = today.toLocaleDateString("es-HN", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });

      pdfClient.textContent = client?.nombre || "-";
      pdfRtn.textContent = client?.rtn || "-";
      pdfPhone.textContent = client?.telefono || "-";
      pdfTotal.textContent = formattedTotal;
      pdfCount.textContent = `${invoiceCount}`;
      pdfDate.textContent = `Fecha: ${formattedDate}`;
    };

    const renderInvoicesForClient = (clientId) => {
      const client = clientes.find((item) => String(item.id) === String(clientId));
      accountRtnInput.value = client?.rtn || "";
      accountPhoneInput.value = client?.telefono || "";
      accountClientLabel.textContent = `Cliente: ${client?.nombre || "-"}`;
      currentPdfUrl = "";

      if (!clientId) {
        accountTotalLabel.textContent = formatCurrency(0);
        accountCountLabel.textContent = "0";
        updatePdfMeta(null, 0, 0);
        renderEmptyInvoices("Selecciona un cliente para ver facturas pendientes.");
        return;
      }

      const invoices = facturasCredito.filter(
        (factura) => String(factura.cliente_id) === String(clientId)
      );
      let totalSaldo = 0;
      accountInvoiceBody.innerHTML = "";
      accountPdfBody.innerHTML = "";

      if (!invoices.length) {
        accountTotalLabel.textContent = formatCurrency(0);
        accountCountLabel.textContent = "0";
        updatePdfMeta(client, 0, 0);
        renderEmptyInvoices("No hay facturas pendientes para este cliente.");
        return;
      }

      invoices.forEach((factura) => {
        totalSaldo += factura.saldo || 0;
        const row = document.createElement("div");
        row.className = "account-invoice-row";
        row.innerHTML = `
          <span>${factura.numero_factura}</span>
          <span>${factura.fecha}</span>
          <span>${formatCurrency(factura.total)}</span>
          <span>${formatCurrency(factura.saldo)}</span>
        `;
        accountInvoiceBody.appendChild(row);

        const pdfRow = document.createElement("div");
        pdfRow.className = "account-pdf-row";
        pdfRow.innerHTML = `
          <span>${factura.numero_factura}</span>
          <span>${factura.fecha}</span>
          <span>${formatCurrency(factura.total)}</span>
          <span>${formatCurrency(factura.saldo)}</span>
        `;
        accountPdfBody.appendChild(pdfRow);
      });

      accountTotalLabel.textContent = formatCurrency(totalSaldo);
      accountCountLabel.textContent = `${invoices.length}`;
      updatePdfMeta(client, totalSaldo, invoices.length);
    };

    const openAccountModal = () => {
      accountClientSelect.value = "";
      renderInvoicesForClient("");
      accountModal.classList.add("open");
    };

    accountOpenButtons.forEach((button) => {
      button.addEventListener("click", () => openAccountModal());
    });

    accountCloseButtons.forEach((button) => {
      button.addEventListener("click", () => accountModal.classList.remove("open"));
    });

    accountClientSelect.addEventListener("change", (event) => {
      renderInvoicesForClient(event.target.value);
    });

    accountPhoneInput.addEventListener("input", () => {
      pdfPhone.textContent = accountPhoneInput.value.trim() || "-";
    });

    accountPrintButton.addEventListener("click", async () => {
      const clientId = accountClientSelect.value;
      if (!clientId) {
        alert("Selecciona un cliente para generar el PDF.");
        return;
      }
      try {
        const response = await fetch("/reportes/estado-cuenta/pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cliente_id: clientId }),
        });
        if (!response.ok) {
          throw new Error("No se pudo generar el PDF.");
        }
        const result = await response.json();
        currentPdfUrl = result.pdf_url || "";
        if (currentPdfUrl) {
          window.open(currentPdfUrl, "_blank");
        }
      } catch (error) {
        alert("No se pudo generar el PDF.");
      }
    });

    accountWhatsappButton.addEventListener("click", () => {
      const phone = accountPhoneInput.value.replace(/\\D/g, "");
      if (!phone) {
        alert("Ingresa un telefono de WhatsApp para continuar.");
        return;
      }
      if (!currentPdfUrl) {
        alert("Primero genera el PDF para poder enviarlo.");
        return;
      }
      const client = accountClientSelect.options[accountClientSelect.selectedIndex]?.text || "";
      const message = encodeURIComponent(
        `Hola ${client}. Te envio el estado de cuenta. PDF: ${currentPdfUrl}`
      );
      window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
    });
  </script>
{% endblock %}
