{% extends "base.html" %}
{% block title %}Facturacion | Invagro{% endblock %}
{% block body_class %}page dashboard-page pos-page{% endblock %}
{% block content %}
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="/static/assets/logo.jpg" alt="Invagro" />
        <h3>Invagro</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard">Dashboard</a>
        <a class="nav-item active" href="/facturacion">Facturacion</a>
        <a class="nav-item" href="/facturas/credito">Facturas credito</a>
        <a class="nav-item" href="/facturas/historial">Historial facturas</a>
        <a class="nav-item" href="/clientes">Clientes</a>
        <a class="nav-item" href="/productos">Productos</a>
        <a class="nav-item" href="/reportes">Reportes</a>
        <a class="nav-item" href="/ajustes">Ajustes</a>
      </nav>
      <div class="sidebar-footer">
        <img class="sidebar-mascot" src="/static/assets/mascota.jpeg" alt="Mascota" />
      </div>
    </aside>

    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <h2>Facturacion</h2>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Sesion: {{ user }}</span>
        </div>
      </div>

      <main class="content-area pos-layout">
        <section class="pos-left">
          <div class="pos-search">
            <input
              type="text"
              placeholder="Buscar producto por codigo o nombre"
              id="product-search"
            />
            <button class="primary-button" type="button" id="clear-search">
              Limpiar
            </button>
          </div>

          <div class="pos-tabs">
            <button class="tab active" data-filter="todos">Todos</button>
            {% for categoria in categorias %}
              <button
                class="tab"
                data-filter="{{ categoria.nombre|lower|replace(' ', '-') }}"
              >
                {{ categoria.nombre }}
              </button>
            {% endfor %}
          </div>

          <div class="pos-grid">
            {% for producto in productos %}
              <article
                class="pos-product"
                data-id="{{ producto.id }}"
                data-name="{{ producto.nombre }}"
                data-price="{{ producto.precio }}"
                data-category="{{ producto.categoria|lower|replace(' ', '-') }}"
                data-isv="{{ 1 if producto.isv_aplica else 0 }}"
              >
                {% set product_image = url_for('static', filename='uploads/productos/' ~ producto.foto) if producto.foto else url_for('static', filename='assets/shampoo.jpeg') %}
                <img src="{{ product_image }}" alt="{{ producto.nombre }}" />
                <div>
                  <h4>{{ producto.nombre }}</h4>
                  <span>L {{ "%.2f"|format(producto.precio) }}</span>
                </div>
                <button type="button" class="add-product">Agregar</button>
              </article>
            {% endfor %}
          </div>
        </section>

        <section class="pos-right">
          <div class="pos-header">
            <div>
              <h3>Documento</h3>
              <span>F001-000012</span>
            </div>
            <div class="pos-type">
              <label>
                <input type="radio" name="tipo" value="contado" checked />
                Contado
              </label>
              <label>
                <input type="radio" name="tipo" value="credito" />
                Credito
              </label>
            </div>
          </div>

          <div class="pos-client">
            <div>
              <label>Cliente</label>
              <select id="cliente-select">
                <option value="">Selecciona un cliente</option>
                {% for cliente in clientes %}
                  <option value="{{ cliente.id }}" data-rtn="{{ cliente.ruc_dni or '' }}">
                    {{ cliente.nombre }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>RTN</label>
              <input type="text" id="cliente-rtn" placeholder="RTN" />
            </div>
          </div>

          <div class="pos-table" id="invoice-table">
            <div class="table-header table-five">
              <span>Descripcion</span>
              <span>Cant.</span>
              <span>Precio</span>
              <span>Total</span>
              <span>Quitar</span>
            </div>
            <div class="table-row table-five empty-row">
              <span>Sin productos</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
            </div>
          </div>

          <div class="pos-summary">
            <div>
              <span>Subtotal</span>
              <strong id="subtotal">L 0.00</strong>
            </div>
            <div>
              <span>ISV (15%)</span>
              <strong id="isv">L 0.00</strong>
            </div>
            <div class="pos-total">
              <span>Total</span>
              <strong id="total">L 0.00</strong>
            </div>
          </div>

          <div class="pos-actions">
            <button class="secondary-button" type="button">Guardar borrador</button>
            <button class="primary-button" type="button" id="emit-invoice">Emitir factura</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="modal" id="invoice-modal">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h3>Resumen de factura</h3>
          <span id="invoice-client">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-invoice-close>×</button>
      </div>
      <div class="invoice-modal-body">
        <div class="invoice-meta">
          <span id="invoice-rtn">RTN: -</span>
          <span id="invoice-type">Tipo: Contado</span>
        </div>
        <div class="invoice-items" id="invoice-items"></div>
        <div class="invoice-modal-summary">
          <div>
            <span>Subtotal</span>
            <strong id="invoice-subtotal">L 0.00</strong>
          </div>
          <div>
            <span>Importe exento</span>
            <strong id="invoice-exento">L 0.00</strong>
          </div>
          <div>
            <span>Importe gravado</span>
            <strong id="invoice-gravado">L 0.00</strong>
          </div>
          <div>
            <span>ISV</span>
            <strong id="invoice-isv">L 0.00</strong>
          </div>
          <div>
            <span>Descuento</span>
            <strong id="invoice-discount">L 0.00</strong>
          </div>
          <div id="invoice-balance-row">
            <span>Saldo</span>
            <strong id="invoice-balance">L 0.00</strong>
          </div>
          <div class="invoice-total">
            <span>Total</span>
            <strong id="invoice-total">L 0.00</strong>
          </div>
        </div>
        <div class="invoice-payment">
          <label>
            <span>Paga con</span>
            <input type="number" min="0" step="0.01" id="invoice-paid" />
          </label>
          <label>
            <span>Descuento</span>
            <input type="number" min="0" step="0.01" id="invoice-discount-input" />
          </label>
          <div class="change-box">
            <span>Cambio</span>
            <strong id="invoice-change">L 0.00</strong>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-invoice-close>Cancelar</button>
        <button class="primary-button" type="button" id="confirm-invoice">Confirmar</button>
        <a class="secondary-button" id="invoice-pdf-link" href="#" target="_blank" style="display:none;">
          Ver PDF
        </a>
        <a class="secondary-button" id="invoice-whatsapp-link" href="#" target="_blank" style="display:none;">
          Enviar WhatsApp
        </a>
      </div>
    </div>
  </div>
  <script>
    const taxRate = 0.15;
    const productCards = Array.from(document.querySelectorAll(".pos-product"));
    const invoiceTable = document.getElementById("invoice-table");
    const emptyRow = invoiceTable.querySelector(".empty-row");
    const subtotalEl = document.getElementById("subtotal");
    const isvEl = document.getElementById("isv");
    const totalEl = document.getElementById("total");
    const searchInput = document.getElementById("product-search");
    const clearSearch = document.getElementById("clear-search");
    const tabs = document.querySelectorAll(".pos-tabs .tab");
    const clientSelect = document.getElementById("cliente-select");
    const clientRtnInput = document.getElementById("cliente-rtn");
    const emitButton = document.getElementById("emit-invoice");
    const invoiceModal = document.getElementById("invoice-modal");
    const invoiceCloseButtons = invoiceModal
      ? invoiceModal.querySelectorAll("[data-invoice-close]")
      : [];
    const invoiceItems = document.getElementById("invoice-items");
    const invoiceSubtotal = document.getElementById("invoice-subtotal");
    const invoiceExento = document.getElementById("invoice-exento");
    const invoiceGravado = document.getElementById("invoice-gravado");
    const invoiceIsv = document.getElementById("invoice-isv");
    const invoiceDiscount = document.getElementById("invoice-discount");
    const invoiceDiscountInput = document.getElementById("invoice-discount-input");
    const invoiceTotal = document.getElementById("invoice-total");
    const invoicePaid = document.getElementById("invoice-paid");
    const invoiceChange = document.getElementById("invoice-change");
    const invoiceClient = document.getElementById("invoice-client");
    const invoiceRtn = document.getElementById("invoice-rtn");
    const invoiceType = document.getElementById("invoice-type");
    const invoiceBalanceRow = document.getElementById("invoice-balance-row");
    const invoiceBalance = document.getElementById("invoice-balance");
    const confirmInvoice = document.getElementById("confirm-invoice");
    const invoicePdfLink = document.getElementById("invoice-pdf-link");
    const invoiceWhatsappLink = document.getElementById("invoice-whatsapp-link");
    let modalTotalValue = 0;
    let modalInvoiceType = "contado";

    const formatCurrency = (value) => `L ${value.toFixed(2)}`;

    const updateTotals = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      let subtotal = 0;
      let isv = 0;

      rows.forEach((row) => {
        const qty = Number(row.querySelector(".qty-input").value || 0);
        const price = Number(row.dataset.price || 0);
        const line = qty * price;
        const applyTax = row.dataset.isv === "1";
        subtotal += line;
        if (applyTax) {
          isv += line * taxRate;
        }
        row.querySelector(".line-total").textContent = formatCurrency(line);
      });

      const discountValue = Number(invoiceDiscountInput ? invoiceDiscountInput.value : 0) || 0;
      const grossTotal = subtotal + isv;
      const safeDiscount = Math.max(0, Math.min(discountValue, grossTotal));
      subtotalEl.textContent = formatCurrency(subtotal);
      isvEl.textContent = formatCurrency(isv);
      totalEl.textContent = formatCurrency(Math.max(0, grossTotal - safeDiscount));
      if (invoiceModal && invoiceModal.classList.contains("open")) {
        openInvoiceModal();
      }
    };

    const ensureEmptyState = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      if (rows.length === 0) {
        emptyRow.style.display = "grid";
      } else {
        emptyRow.style.display = "none";
      }
    };

    const addRow = (card) => {
      const id = card.dataset.id;
      const existing = invoiceTable.querySelector(`.invoice-row[data-id="${id}"]`);
      if (existing) {
        const qtyInput = existing.querySelector(".qty-input");
        qtyInput.value = Number(qtyInput.value || 0) + 1;
        updateTotals();
        return;
      }

      const row = document.createElement("div");
      row.className = "table-row table-five invoice-row";
      row.dataset.id = id;
      row.dataset.price = card.dataset.price;
      row.dataset.isv = card.dataset.isv;
      row.innerHTML = `
        <span>${card.dataset.name}</span>
        <input class="qty-input" type="number" min="1" value="1" />
        <span>${formatCurrency(Number(card.dataset.price))}</span>
        <span class="line-total">${formatCurrency(Number(card.dataset.price))}</span>
        <button class="remove-button" type="button">×</button>
      `;

      invoiceTable.appendChild(row);
      row.querySelector(".qty-input").addEventListener("input", updateTotals);
      row.querySelector(".remove-button").addEventListener("click", () => {
        row.remove();
        ensureEmptyState();
        updateTotals();
      });

      ensureEmptyState();
      updateTotals();
    };

    productCards.forEach((card) => {
      card.querySelector(".add-product").addEventListener("click", () => addRow(card));
    });

    const applyFilters = () => {
      const query = searchInput.value.trim().toLowerCase();
      const activeTab = document.querySelector(".pos-tabs .tab.active");
      const filter = activeTab ? activeTab.dataset.filter : "todos";

      productCards.forEach((card) => {
        const name = card.dataset.name.toLowerCase();
        const category = card.dataset.category.toLowerCase();
        const matchesSearch = !query || name.includes(query);
        const matchesCategory = filter === "todos" || category === filter;
        card.style.display = matchesSearch && matchesCategory ? "grid" : "none";
      });
    };

    searchInput.addEventListener("input", applyFilters);
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      applyFilters();
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((item) => item.classList.remove("active"));
        tab.classList.add("active");
        applyFilters();
      });
    });

    if (clientSelect && clientRtnInput) {
      clientSelect.addEventListener("change", () => {
        const option = clientSelect.options[clientSelect.selectedIndex];
        clientRtnInput.value = option ? option.dataset.rtn || "" : "";
      });
    }

    const getInvoiceType = () => {
      const selected = document.querySelector('input[name="tipo"]:checked');
      return selected ? selected.value : "contado";
    };

    const openInvoiceModal = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      if (!rows.length) {
        alert("Agrega productos antes de emitir la factura.");
        return;
      }

      const selectedOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
      const clientName = selectedOption && selectedOption.value ? selectedOption.textContent.trim() : "-";
      const rtnValue = clientRtnInput ? clientRtnInput.value.trim() : "";
      if (invoiceClient) {
        invoiceClient.textContent = `Cliente: ${clientName || "-"}`;
      }
      if (invoiceRtn) {
        invoiceRtn.textContent = `RTN: ${rtnValue || "-"}`;
      }
      modalInvoiceType = getInvoiceType();
      if (invoiceType) {
        invoiceType.textContent = `Tipo: ${modalInvoiceType === "credito" ? "Credito" : "Contado"}`;
      }

      let subtotal = 0;
      let isv = 0;
      let exento = 0;
      let gravado = 0;
      const itemsHtml = Array.from(rows)
        .map((row) => {
          const qty = Number(row.querySelector(".qty-input").value || 0);
          const price = Number(row.dataset.price || 0);
          const line = qty * price;
          const applyTax = row.dataset.isv === "1";
          if (applyTax) {
            isv += line * taxRate;
            gravado += line;
          } else {
            exento += line;
          }
          subtotal += line;
          return `
            <div class="invoice-item">
              <span>${row.querySelector("span").textContent}</span>
              <span>${qty} x ${formatCurrency(price)}</span>
              <strong>${formatCurrency(line)}</strong>
            </div>
          `;
        })
        .join("");

      modalTotalValue = subtotal + isv;
      const discountValue = Number(invoiceDiscountInput ? invoiceDiscountInput.value : 0) || 0;
      const safeDiscount = Math.max(0, Math.min(discountValue, modalTotalValue));
      modalTotalValue = Math.max(0, modalTotalValue - safeDiscount);
      if (invoiceItems) {
        invoiceItems.innerHTML = itemsHtml;
      }
      if (invoiceSubtotal) {
        invoiceSubtotal.textContent = formatCurrency(subtotal);
      }
      if (invoiceExento) {
        invoiceExento.textContent = formatCurrency(exento);
      }
      if (invoiceGravado) {
        invoiceGravado.textContent = formatCurrency(gravado);
      }
      if (invoiceIsv) {
        invoiceIsv.textContent = formatCurrency(isv);
      }
      if (invoiceDiscount) {
        invoiceDiscount.textContent = formatCurrency(safeDiscount);
      }
      if (invoiceTotal) {
        invoiceTotal.textContent = formatCurrency(modalTotalValue);
      }
      if (invoicePaid) {
        invoicePaid.value = modalTotalValue.toFixed(2);
      }
      if (invoiceDiscountInput && !invoiceDiscountInput.value) {
        invoiceDiscountInput.value = "0.00";
      }
      if (invoiceChange) {
        invoiceChange.textContent = formatCurrency(0);
      }
      if (invoiceBalanceRow && invoiceBalance) {
        invoiceBalanceRow.style.display = modalInvoiceType === "credito" ? "flex" : "none";
        invoiceBalance.textContent = formatCurrency(0);
      }

      if (invoiceModal) {
        invoiceModal.classList.add("open");
      }
      if (invoicePdfLink) {
        invoicePdfLink.style.display = "none";
        invoicePdfLink.href = "#";
      }
      if (invoiceWhatsappLink) {
        invoiceWhatsappLink.style.display = "none";
        invoiceWhatsappLink.href = "#";
      }
      if (confirmInvoice) {
        confirmInvoice.style.display = "inline-flex";
      }
    };

    const updateChange = () => {
      if (!invoicePaid || !invoiceChange) {
        return;
      }
      const paid = Number(invoicePaid.value || 0);
      const change = Math.max(0, paid - modalTotalValue);
      if (modalInvoiceType === "credito") {
        invoiceChange.textContent = formatCurrency(0);
        if (invoiceBalance) {
          const balance = Math.max(0, modalTotalValue - paid);
          invoiceBalance.textContent = formatCurrency(balance);
        }
      } else {
        invoiceChange.textContent = formatCurrency(change);
        if (invoiceBalance) {
          invoiceBalance.textContent = formatCurrency(0);
        }
      }
    };

    if (emitButton) {
      emitButton.addEventListener("click", openInvoiceModal);
    }

    invoiceCloseButtons.forEach((button) => {
      button.addEventListener("click", () => {
        if (invoiceModal) {
          invoiceModal.classList.remove("open");
        }
      });
    });

    if (invoiceModal) {
      invoiceModal.addEventListener("click", (event) => {
        if (event.target === invoiceModal) {
          invoiceModal.classList.remove("open");
        }
      });
    }

    if (invoicePaid) {
      invoicePaid.addEventListener("input", updateChange);
    }
    if (invoiceDiscountInput) {
      invoiceDiscountInput.addEventListener("input", () => {
        updateTotals();
        if (invoiceModal && invoiceModal.classList.contains("open")) {
          openInvoiceModal();
        }
      });
    }

    if (confirmInvoice) {
      confirmInvoice.addEventListener("click", async () => {
        const rows = invoiceTable.querySelectorAll(".invoice-row");
        if (!rows.length) {
          alert("Agrega productos antes de emitir la factura.");
          return;
        }
        const selectedOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
        const clienteId = selectedOption && selectedOption.value ? Number(selectedOption.value) : null;
        const rtnValue = clientRtnInput ? clientRtnInput.value.trim() : "";
        const paid = Number(invoicePaid ? invoicePaid.value : 0);
        const discountValue = Number(invoiceDiscountInput ? invoiceDiscountInput.value : 0) || 0;
        const tipo = modalInvoiceType;
        if (tipo === "contado" && paid < modalTotalValue) {
          alert("En contado, el pago debe ser igual o mayor al total.");
          return;
        }
        const items = Array.from(rows).map((row) => ({
          producto_id: Number(row.dataset.id),
          cantidad: Number(row.querySelector(".qty-input").value || 0),
        }));

        try {
          const response = await fetch("/facturas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tipo,
              cliente_id: clienteId,
              rtn: rtnValue,
              pago: paid,
              descuento: discountValue,
              items,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            alert(result.error || "No se pudo guardar la factura.");
            return;
          }
          alert(`Factura guardada: ${result.numero_factura}`);
          if (confirmInvoice) {
            confirmInvoice.style.display = "none";
          }
          if (result.pdf_url && invoicePdfLink) {
            invoicePdfLink.href = result.pdf_url;
            invoicePdfLink.style.display = "inline-flex";
          }
          if (invoiceWhatsappLink && result.pdf_url) {
            const pdfUrl = new URL(result.pdf_url, window.location.origin).toString();
            const message = encodeURIComponent(
              `Factura ${result.numero_factura} - Total L ${modalTotalValue.toFixed(2)} - PDF: ${pdfUrl}`
            );
            invoiceWhatsappLink.href = `https://wa.me/?text=${message}`;
            invoiceWhatsappLink.style.display = "inline-flex";
          }
          // Mantener modal abierto para que pueda ver PDF/WhatsApp.
        } catch (error) {
          alert("No se pudo guardar la factura.");
        }
      });
    }
  </script>
{% endblock %}
