{% extends "base.html" %}
{% block title %}Facturacion | Invagro{% endblock %}
{% block body_class %}page dashboard-page pos-page{% endblock %}
{% block content %}
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="/static/assets/logo.jpg" alt="Invagro" />
        <h3>Invagro</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard">Dashboard</a>
        <a class="nav-item active" href="/facturacion">Facturacion</a>
        <a class="nav-item" href="/clientes">Clientes</a>
        <a class="nav-item" href="/productos">Productos</a>
        <a class="nav-item" href="/reportes">Reportes</a>
      </nav>
      <div class="sidebar-footer">
        <img class="sidebar-mascot" src="/static/assets/mascota.jpeg" alt="Mascota" />
      </div>
    </aside>

    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <h2>Facturacion</h2>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Sesion: {{ user }}</span>
        </div>
      </div>

      <main class="content-area pos-layout">
        <section class="pos-left">
          <div class="pos-search">
            <input
              type="text"
              placeholder="Buscar producto por codigo o nombre"
              id="product-search"
            />
            <button class="primary-button" type="button" id="clear-search">
              Limpiar
            </button>
          </div>

          <div class="pos-tabs">
            <button class="tab active" data-filter="todos">Todos</button>
            {% for categoria in categorias %}
              <button
                class="tab"
                data-filter="{{ categoria.nombre|lower|replace(' ', '-') }}"
              >
                {{ categoria.nombre }}
              </button>
            {% endfor %}
          </div>

          <div class="pos-grid">
            {% for producto in productos %}
              <article
                class="pos-product"
                data-id="{{ producto.id }}"
                data-name="{{ producto.nombre }}"
                data-price="{{ producto.precio }}"
                data-category="{{ producto.categoria|lower|replace(' ', '-') }}"
              >
                <img src="/static/assets/shampoo.jpeg" alt="{{ producto.nombre }}" />
                <div>
                  <h4>{{ producto.nombre }}</h4>
                  <span>L {{ "%.2f"|format(producto.precio) }}</span>
                </div>
                <button type="button" class="add-product">Agregar</button>
              </article>
            {% endfor %}
          </div>
        </section>

        <section class="pos-right">
          <div class="pos-header">
            <div>
              <h3>Documento</h3>
              <span>F001-000012</span>
            </div>
            <div class="pos-type">
              <label>
                <input type="radio" name="tipo" checked />
                Contado
              </label>
              <label>
                <input type="radio" name="tipo" />
                Credito
              </label>
            </div>
          </div>

          <div class="pos-client">
            <div>
              <label>Cliente</label>
              <select>
                <option value="">Selecciona un cliente</option>
                {% for cliente in clientes %}
                  <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>Documento</label>
              <input type="text" placeholder="RUC/DNI" />
            </div>
          </div>

          <div class="pos-table" id="invoice-table">
            <div class="table-header table-six">
              <span>Descripcion</span>
              <span>Cant.</span>
              <span>Precio</span>
              <span>ISV</span>
              <span>Total</span>
              <span>Quitar</span>
            </div>
            <div class="table-row table-six empty-row">
              <span>Sin productos</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
            </div>
          </div>

          <div class="pos-summary">
            <div>
              <span>Subtotal</span>
              <strong id="subtotal">L 0.00</strong>
            </div>
            <div>
              <span>ISV (15%)</span>
              <strong id="isv">L 0.00</strong>
            </div>
            <div class="pos-total">
              <span>Total</span>
              <strong id="total">L 0.00</strong>
            </div>
          </div>

          <div class="pos-actions">
            <button class="secondary-button" type="button">Guardar borrador</button>
            <button class="primary-button" type="button">Emitir factura</button>
          </div>
        </section>
      </main>
    </div>
  </div>
  <script>
    const taxRate = 0.15;
    const productCards = Array.from(document.querySelectorAll(".pos-product"));
    const invoiceTable = document.getElementById("invoice-table");
    const emptyRow = invoiceTable.querySelector(".empty-row");
    const subtotalEl = document.getElementById("subtotal");
    const isvEl = document.getElementById("isv");
    const totalEl = document.getElementById("total");
    const searchInput = document.getElementById("product-search");
    const clearSearch = document.getElementById("clear-search");
    const tabs = document.querySelectorAll(".pos-tabs .tab");

    const formatCurrency = (value) => `L ${value.toFixed(2)}`;

    const updateTotals = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      let subtotal = 0;
      let isv = 0;

      rows.forEach((row) => {
        const qty = Number(row.querySelector(".qty-input").value || 0);
        const price = Number(row.dataset.price || 0);
        const line = qty * price;
        const applyTax = row.querySelector(".tax-checkbox").checked;
        subtotal += line;
        if (applyTax) {
          isv += line * taxRate;
        }
        row.querySelector(".line-total").textContent = formatCurrency(line);
      });

      subtotalEl.textContent = formatCurrency(subtotal);
      isvEl.textContent = formatCurrency(isv);
      totalEl.textContent = formatCurrency(subtotal + isv);
    };

    const ensureEmptyState = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      if (rows.length === 0) {
        emptyRow.style.display = "grid";
      } else {
        emptyRow.style.display = "none";
      }
    };

    const addRow = (card) => {
      const id = card.dataset.id;
      const existing = invoiceTable.querySelector(`.invoice-row[data-id="${id}"]`);
      if (existing) {
        const qtyInput = existing.querySelector(".qty-input");
        qtyInput.value = Number(qtyInput.value || 0) + 1;
        updateTotals();
        return;
      }

      const row = document.createElement("div");
      row.className = "table-row table-six invoice-row";
      row.dataset.id = id;
      row.dataset.price = card.dataset.price;
      row.innerHTML = `
        <span>${card.dataset.name}</span>
        <input class="qty-input" type="number" min="1" value="1" />
        <span>${formatCurrency(Number(card.dataset.price))}</span>
        <label class="tax-toggle">
          <input class="tax-checkbox" type="checkbox" checked />
          <span>ISV</span>
        </label>
        <span class="line-total">${formatCurrency(Number(card.dataset.price))}</span>
        <button class="remove-button" type="button">Ã—</button>
      `;

      invoiceTable.appendChild(row);
      row.querySelector(".qty-input").addEventListener("input", updateTotals);
      row.querySelector(".tax-checkbox").addEventListener("change", updateTotals);
      row.querySelector(".remove-button").addEventListener("click", () => {
        row.remove();
        ensureEmptyState();
        updateTotals();
      });

      ensureEmptyState();
      updateTotals();
    };

    productCards.forEach((card) => {
      card.querySelector(".add-product").addEventListener("click", () => addRow(card));
    });

    const applyFilters = () => {
      const query = searchInput.value.trim().toLowerCase();
      const activeTab = document.querySelector(".pos-tabs .tab.active");
      const filter = activeTab ? activeTab.dataset.filter : "todos";

      productCards.forEach((card) => {
        const name = card.dataset.name.toLowerCase();
        const category = card.dataset.category.toLowerCase();
        const matchesSearch = !query || name.includes(query);
        const matchesCategory = filter === "todos" || category === filter;
        card.style.display = matchesSearch && matchesCategory ? "grid" : "none";
      });
    };

    searchInput.addEventListener("input", applyFilters);
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      applyFilters();
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((item) => item.classList.remove("active"));
        tab.classList.add("active");
        applyFilters();
      });
    });
  </script>
{% endblock %}
