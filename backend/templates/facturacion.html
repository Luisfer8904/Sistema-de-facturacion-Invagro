{% extends "base.html" %}
{% block title %}Facturacion | Invagro{% endblock %}
{% block body_class %}page dashboard-page pos-page{% endblock %}
{% block content %}
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img class="sidebar-logo" src="/static/assets/logo.jpg" alt="Invagro" />
        <h3>Invagro</h3>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="/dashboard"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10.5L12 3l9 7.5M5.25 10.5V20.25h5.25V15h3v5.25h5.25V10.5"/></svg><span class="nav-text">Dashboard</span></a>
        <a class="nav-item active" href="/facturacion"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m-6-8h6M6 4.5h12A1.5 1.5 0 0 1 19.5 6v12A1.5 1.5 0 0 1 18 19.5H6A1.5 1.5 0 0 1 4.5 18V6A1.5 1.5 0 0 1 6 4.5z"/></svg><span class="nav-text">Facturacion</span></a>
        <a class="nav-item" href="/pedidos"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.091.835L5.7 7.5m0 0H19.5l-1.35 6.75a1.125 1.125 0 0 1-1.102.9H7.35a1.125 1.125 0 0 1-1.102-.9L5.7 7.5zm0 0L4.5 4.5m3.75 12.75a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25zm9 0a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25"/></svg><span class="nav-text">Pedidos</span></a>
        <a class="nav-item" href="/facturas/credito"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75A2.25 2.25 0 0 1 4.5 4.5h15A2.25 2.25 0 0 1 21.75 6.75v10.5A2.25 2.25 0 0 1 19.5 19.5h-15A2.25 2.25 0 0 1 2.25 17.25V6.75zm0 1.5h19.5m-15 7.5h6"/></svg><span class="nav-text">Facturas credito</span></a>
        <a class="nav-item" href="/pagos"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12h19.5m-16.5 6h13.5m-15-12h15a2.25 2.25 0 0 1 2.25 2.25v7.5A2.25 2.25 0 0 1 18.75 18h-15A2.25 2.25 0 0 1 1.5 15.75v-7.5A2.25 2.25 0 0 1 3.75 6z"/></svg><span class="nav-text">Pagos</span></a>
        <a class="nav-item" href="/facturas/historial"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2m6-2a10 10 0 1 1-4.293-8.293"/></svg><span class="nav-text">Historial facturas</span></a>
        <a class="nav-item" href="/clientes"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.06 9.06 0 0 0-6-2.22 9.06 9.06 0 0 0-6 2.22M15 9a3 3 0 1 1-6 0 3 3 0 0 1 6 0zm7.5 3a7.5 7.5 0 1 1-15 0 7.5 7.5 0 0 1 15 0z"/></svg><span class="nav-text">Clientes</span></a>
        <a class="nav-item" href="/productos"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25V16.5a2.25 2.25 0 0 1-1.125 1.95l-6.75 3.9a2.25 2.25 0 0 1-2.25 0l-6.75-3.9A2.25 2.25 0 0 1 3 16.5V8.25m18 0-8.25 4.764a2.25 2.25 0 0 1-2.25 0L3 8.25m18 0-8.25-4.764a2.25 2.25 0 0 0-2.25 0L3 8.25"/></svg><span class="nav-text">Productos</span></a>
        <a class="nav-item" href="/reportes"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18M7.5 15.75v-6m4.5 6v-9m4.5 9v-4.5"/></svg><span class="nav-text">Reportes</span></a>
        <a class="nav-item" href="/ajustes"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94a1.5 1.5 0 0 1 2.812 0l.286.857a1.5 1.5 0 0 0 1.346 1.01h.902a1.5 1.5 0 0 1 1.06 2.56l-.655.655a1.5 1.5 0 0 0-.35 1.592l.286.857a1.5 1.5 0 0 1-1.42 1.987h-.902a1.5 1.5 0 0 0-1.346 1.01l-.286.857a1.5 1.5 0 0 1-2.812 0l-.286-.857a1.5 1.5 0 0 0-1.346-1.01h-.902a1.5 1.5 0 0 1-1.06-2.56l.655-.655a1.5 1.5 0 0 0 .35-1.592l-.286-.857a1.5 1.5 0 0 1 1.42-1.987h.902a1.5 1.5 0 0 0 1.346-1.01l.286-.857z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/></svg><span class="nav-text">Ajustes</span></a>
              <a class="nav-item" href="/logout"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6A2.25 2.25 0 0 0 5.25 5.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15"/><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H9m0 0 3-3m-3 3 3 3"/></svg><span class="nav-text">Cerrar sesion</span></a>
      </nav>
      <div class="sidebar-footer">
        <img class="sidebar-mascot" src="/static/assets/mascota.jpeg" alt="Mascota" />
      </div>
    </aside>

    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <h2>Facturacion</h2>
        </div>
        <div class="topbar-right">
          <span class="user-pill">Sesion: {{ user }}</span>
        </div>
      </div>

      <main class="content-area pos-layout">
        <section class="pos-left">
          <div class="pos-search">
            <input
              type="text"
              placeholder="Buscar producto por codigo o nombre"
              id="product-search"
            />
            <button class="primary-button" type="button" id="clear-search">
              Limpiar
            </button>
          </div>

          <div class="pos-tabs">
            <button class="tab active" data-filter="todos">Todos</button>
            {% for categoria in categorias %}
              <button
                class="tab"
                data-filter="{{ categoria.nombre|lower|replace(' ', '-') }}"
              >
                {{ categoria.nombre }}
              </button>
            {% endfor %}
          </div>

          <div class="pos-products-scroll">
            <div class="pos-grid">
              {% for producto in productos %}
                <article
                  class="pos-product"
                  data-id="{{ producto.id }}"
                  data-name="{{ producto.nombre }}"
                  data-price="{{ producto.precio }}"
                  data-category="{{ producto.categoria|lower|replace(' ', '-') }}"
                  data-isv="{{ 1 if producto.isv_aplica else 0 }}"
                >
                  {% set product_image = url_for('static', filename='uploads/productos/' ~ producto.foto) if producto.foto else url_for('static', filename='assets/shampoo.jpeg') %}
                  <img src="{{ product_image }}" alt="{{ producto.nombre }}" />
                  <div>
                    <h4>{{ producto.nombre }}</h4>
                    <span>L {{ "%.2f"|format(producto.precio) }}</span>
                  </div>
                  <button type="button" class="add-product">Agregar</button>
                </article>
              {% endfor %}
            </div>
          </div>
        </section>

        <section class="pos-right">
          <div class="pos-header">
            <div>
              <h3>Documento</h3>
              <span>F001-000012</span>
            </div>
            <div class="pos-type">
              <label>
                <input type="radio" name="tipo" value="contado" checked />
                Contado
              </label>
              <label>
                <input type="radio" name="tipo" value="credito" />
                Credito
              </label>
            </div>
          </div>

          <div class="pos-client">
            <div>
              <label>Cliente</label>
              <div class="cliente-dropdown" id="cliente-dropdown">
                <button type="button" class="cliente-dropdown-toggle" id="cliente-toggle">
                  Selecciona un cliente
                </button>
                <div class="cliente-dropdown-panel" id="cliente-panel">
                  <input type="text" id="cliente-search" placeholder="Buscar cliente..." />
                  <div class="cliente-options" id="cliente-options"></div>
                </div>
                <select id="cliente-select" class="cliente-select-hidden">
                  <option value="">Selecciona un cliente</option>
                  {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" data-rtn="{{ cliente.ruc_dni or '' }}">
                      {{ cliente.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div>
              <label>RTN</label>
              <input type="text" id="cliente-rtn" placeholder="RTN" />
            </div>
          </div>

          <div class="pos-pedidos">
            <div>
              <label>Pedidos listos</label>
              <select id="pedido-select">
                <option value="">Selecciona un pedido</option>
                {% for pedido in pedidos_listos %}
                  <option
                    value="{{ pedido.id }}"
                    data-cliente="{{ pedido.cliente_id or '' }}"
                    data-rtn="{{ pedido.rtn or '' }}"
                    data-numero="{{ pedido.numero_pedido }}"
                  >
                    {{ pedido.numero_pedido }} - {{ clientes_map.get(pedido.cliente_id, 'N/A') }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <button class="secondary-button" type="button" id="load-order">Cargar pedido</button>
          </div>

          <div class="pos-table" id="invoice-table">
            <div class="table-header table-six">
              <span>Descripcion</span>
              <span>Cant.</span>
              <span>Precio</span>
              <span>Descto</span>
              <span>Total</span>
              <span>Quitar</span>
            </div>
            <div class="table-row table-six empty-row">
              <span>Sin productos</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
              <span>-</span>
            </div>
          </div>

          <div class="pos-summary">
            <div>
              <span>Descuento</span>
              <strong id="discount-total">L 0.00</strong>
            </div>
            <div>
              <span>Subtotal</span>
              <strong id="subtotal">L 0.00</strong>
            </div>
            <div>
              <span>ISV (15%)</span>
              <strong id="isv">L 0.00</strong>
            </div>
            <div class="pos-total">
              <span>Total</span>
              <strong id="total">L 0.00</strong>
            </div>
          </div>

          <div class="pos-actions">
            <button class="secondary-button" type="button" id="save-order">Guardar pedido</button>
            <button class="primary-button" type="button" id="emit-invoice">Emitir factura</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="modal" id="invoice-modal">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h3>Resumen de factura</h3>
          <span id="invoice-client">Cliente: -</span>
        </div>
        <button class="modal-close" type="button" data-invoice-close>×</button>
      </div>
      <div class="invoice-modal-body">
        <div class="invoice-meta">
          <span id="invoice-rtn">RTN: -</span>
          <span id="invoice-type">Tipo: Contado</span>
        </div>
        <div class="invoice-date">
          <label>
            <span>Fecha</span>
            <input type="date" id="invoice-date" />
          </label>
        </div>
        <div class="invoice-items" id="invoice-items"></div>
        <div class="invoice-modal-summary">
          <div>
            <span>Subtotal</span>
            <strong id="invoice-subtotal">L 0.00</strong>
          </div>
          <div>
            <span>Importe exento</span>
            <strong id="invoice-exento">L 0.00</strong>
          </div>
          <div>
            <span>Importe gravado</span>
            <strong id="invoice-gravado">L 0.00</strong>
          </div>
          <div>
            <span>ISV</span>
            <strong id="invoice-isv">L 0.00</strong>
          </div>
          <div>
            <span>Descuento</span>
            <strong id="invoice-discount">L 0.00</strong>
          </div>
          <div id="invoice-balance-row">
            <span>Saldo</span>
            <strong id="invoice-balance">L 0.00</strong>
          </div>
          <div class="invoice-total">
            <span>Total</span>
            <strong id="invoice-total">L 0.00</strong>
          </div>
        </div>
        <div class="invoice-payment">
          <label>
            <span>Paga con</span>
            <input type="number" min="0" step="0.01" id="invoice-paid" />
          </label>
          <div class="change-box">
            <span>Cambio</span>
            <strong id="invoice-change">L 0.00</strong>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="secondary-button" type="button" data-invoice-close>Cancelar</button>
        <button class="primary-button" type="button" id="confirm-invoice">Confirmar</button>
        <a class="secondary-button" id="invoice-pdf-link" href="#" target="_blank" style="display:none;">
          Ver PDF
        </a>
        <a class="secondary-button" id="invoice-whatsapp-link" href="#" target="_blank" style="display:none;">
          Enviar WhatsApp
        </a>
      </div>
    </div>
  </div>
  <script>
    const taxRate = 0.15;
    const productCards = Array.from(document.querySelectorAll(".pos-product"));
    const invoiceTable = document.getElementById("invoice-table");
    const emptyRow = invoiceTable.querySelector(".empty-row");
    const subtotalEl = document.getElementById("subtotal");
    const discountTotalEl = document.getElementById("discount-total");
    const isvEl = document.getElementById("isv");
    const totalEl = document.getElementById("total");
    const searchInput = document.getElementById("product-search");
    const clearSearch = document.getElementById("clear-search");
    const tabs = document.querySelectorAll(".pos-tabs .tab");
    const clientSelect = document.getElementById("cliente-select");
    const clientDropdown = document.getElementById("cliente-dropdown");
    const clientToggle = document.getElementById("cliente-toggle");
    const clientPanel = document.getElementById("cliente-panel");
    const clientOptionsContainer = document.getElementById("cliente-options");
    const clientSearch = document.getElementById("cliente-search");
    const clientRtnInput = document.getElementById("cliente-rtn");
    const pedidoSelect = document.getElementById("pedido-select");
    const loadOrderButton = document.getElementById("load-order");
    const saveOrderButton = document.getElementById("save-order");
    const emitButton = document.getElementById("emit-invoice");
    const invoiceModal = document.getElementById("invoice-modal");
    const invoiceCloseButtons = invoiceModal
      ? invoiceModal.querySelectorAll("[data-invoice-close]")
      : [];
    const invoiceItems = document.getElementById("invoice-items");
    const invoiceSubtotal = document.getElementById("invoice-subtotal");
    const invoiceExento = document.getElementById("invoice-exento");
    const invoiceGravado = document.getElementById("invoice-gravado");
    const invoiceIsv = document.getElementById("invoice-isv");
    const invoiceDiscount = document.getElementById("invoice-discount");
    const invoiceTotal = document.getElementById("invoice-total");
    const invoicePaid = document.getElementById("invoice-paid");
    const invoiceChange = document.getElementById("invoice-change");
    const invoiceClient = document.getElementById("invoice-client");
    const invoiceRtn = document.getElementById("invoice-rtn");
    const invoiceType = document.getElementById("invoice-type");
    const invoiceBalanceRow = document.getElementById("invoice-balance-row");
    const invoiceBalance = document.getElementById("invoice-balance");
    const invoiceDateInput = document.getElementById("invoice-date");
    const confirmInvoice = document.getElementById("confirm-invoice");
    const invoicePdfLink = document.getElementById("invoice-pdf-link");
    const invoiceWhatsappLink = document.getElementById("invoice-whatsapp-link");
    const productMap = new Map(productCards.map((card) => [card.dataset.id, card]));
    const clientOptions = clientSelect
      ? Array.from(clientSelect.querySelectorAll("option"))
      : [];
    let modalTotalValue = 0;
    let modalInvoiceType = "contado";
    let currentPedidoId = null;
    let isLoadingPedido = false;

    const formatCurrency = (value) => `L ${value.toFixed(2)}`;
    const toDateInputValue = (date) => {
      const offset = date.getTimezoneOffset() * 60000;
      return new Date(date.getTime() - offset).toISOString().slice(0, 10);
    };

    const updateClientSelection = () => {
      if (!clientSelect) {
        return;
      }
      const option = clientSelect.options[clientSelect.selectedIndex];
      const label = option && option.value ? option.textContent.trim() : "Selecciona un cliente";
      if (clientToggle) {
        clientToggle.textContent = label;
      }
      if (clientRtnInput) {
        clientRtnInput.value = option ? option.dataset.rtn || "" : "";
      }
    };

    const renderClientOptions = (query) => {
      if (!clientOptionsContainer) {
        return;
      }
      const normalized = (query || "").toLowerCase().trim();
      clientOptionsContainer.innerHTML = "";
      let matches = 0;
      clientOptions.forEach((option) => {
        if (!option.value) {
          return;
        }
        const name = (option.textContent || "").toLowerCase();
        if (!normalized || name.includes(normalized)) {
          matches += 1;
          const item = document.createElement("button");
          item.type = "button";
          item.className = "cliente-option";
          item.dataset.value = option.value;
          item.dataset.rtn = option.dataset.rtn || "";
          item.textContent = option.textContent.trim();
          if (clientSelect && clientSelect.value === option.value) {
            item.classList.add("active");
          }
          item.addEventListener("click", () => {
            if (clientSelect) {
              clientSelect.value = option.value;
            }
            updateClientSelection();
            if (clientSearch) {
              renderClientOptions(clientSearch.value);
            }
            if (clientPanel) {
              clientPanel.classList.remove("open");
            }
          });
          clientOptionsContainer.appendChild(item);
        }
      });
      if (matches === 0) {
        const empty = document.createElement("div");
        empty.className = "cliente-option-empty";
        empty.textContent = "No hay resultados";
        clientOptionsContainer.appendChild(empty);
      }
    };

    const closeClientDropdown = () => {
      if (clientPanel) {
        clientPanel.classList.remove("open");
      }
    };

    if (clientToggle && clientPanel) {
      clientToggle.addEventListener("click", () => {
        clientPanel.classList.toggle("open");
        if (clientPanel.classList.contains("open")) {
          renderClientOptions(clientSearch ? clientSearch.value : "");
        }
        if (clientPanel.classList.contains("open") && clientSearch) {
          clientSearch.focus();
        }
      });
    }

    if (clientSearch) {
      clientSearch.addEventListener("input", (event) => {
        renderClientOptions(event.target.value);
      });
    }

    if (clientDropdown) {
      document.addEventListener("click", (event) => {
        if (!clientDropdown.contains(event.target)) {
          closeClientDropdown();
        }
      });
    }

    renderClientOptions("");
    updateClientSelection();

    const updateTotals = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      let grossSubtotal = 0;
      let isv = 0;
      let discountTotal = 0;

      rows.forEach((row) => {
        const qty = Number(row.querySelector(".qty-input").value || 0);
        const price = Number(row.dataset.price || 0);
        const line = qty * price;
        const discountUnit = Number(row.querySelector(".discount-input").value || 0);
        const safeDiscountUnit = Math.max(0, Math.min(discountUnit, price));
        const lineNet = Math.max(0, (price - safeDiscountUnit) * qty);
        const applyTax = row.dataset.isv === "1";
        grossSubtotal += line;
        discountTotal += safeDiscountUnit * qty;
        if (applyTax) {
          isv += lineNet * taxRate;
        }
        row.querySelector(".line-total").textContent = formatCurrency(lineNet);
      });

      const netSubtotal = Math.max(0, grossSubtotal - discountTotal);
      subtotalEl.textContent = formatCurrency(grossSubtotal);
      if (discountTotalEl) {
        discountTotalEl.textContent = formatCurrency(discountTotal);
      }
      isvEl.textContent = formatCurrency(isv);
      totalEl.textContent = formatCurrency(Math.max(0, netSubtotal + isv));
      if (invoiceModal && invoiceModal.classList.contains("open")) {
        openInvoiceModal();
      }
    };

    const ensureEmptyState = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      if (rows.length === 0) {
        emptyRow.style.display = "grid";
      } else {
        emptyRow.style.display = "none";
      }
    };

    const clearPedidoContext = () => {
      if (currentPedidoId) {
        currentPedidoId = null;
      }
      if (pedidoSelect && !isLoadingPedido) {
        pedidoSelect.value = "";
      }
    };

    const clearInvoiceRows = () => {
      invoiceTable.querySelectorAll(".invoice-row").forEach((row) => row.remove());
      ensureEmptyState();
      updateTotals();
    };

    const addRow = (card, options = {}) => {
      const { quantity = 1, discount = 0, replace = false } = options;
      const id = card.dataset.id;
      const existing = invoiceTable.querySelector(`.invoice-row[data-id="${id}"]`);
      if (existing) {
        const qtyInput = existing.querySelector(".qty-input");
        const nextQty = replace ? quantity : Number(qtyInput.value || 0) + 1;
        qtyInput.value = nextQty;
        if (replace) {
          existing.querySelector(".discount-input").value = discount;
        }
        updateTotals();
        return;
      }

      const row = document.createElement("div");
      row.className = "table-row table-six invoice-row";
      row.dataset.id = id;
      row.dataset.price = card.dataset.price;
      row.dataset.isv = card.dataset.isv;
      row.innerHTML = `
        <span>${card.dataset.name}</span>
        <input class="qty-input" type="number" min="1" value="${quantity}" />
        <span>${formatCurrency(Number(card.dataset.price))}</span>
        <input class="discount-input" type="number" min="0" step="0.01" value="${discount}" />
        <span class="line-total">${formatCurrency(Number(card.dataset.price))}</span>
        <button class="remove-button" type="button">×</button>
      `;

      invoiceTable.appendChild(row);
      row.querySelector(".qty-input").addEventListener("input", () => {
        clearPedidoContext();
        updateTotals();
      });
      row.querySelector(".discount-input").addEventListener("input", () => {
        clearPedidoContext();
        updateTotals();
      });
      row.querySelector(".remove-button").addEventListener("click", () => {
        row.remove();
        clearPedidoContext();
        ensureEmptyState();
        updateTotals();
      });

      if (!isLoadingPedido) {
        clearPedidoContext();
      }
      ensureEmptyState();
      updateTotals();
    };

    productCards.forEach((card) => {
      card.querySelector(".add-product").addEventListener("click", () => addRow(card));
    });

    const applyFilters = () => {
      const query = searchInput.value.trim().toLowerCase();
      const activeTab = document.querySelector(".pos-tabs .tab.active");
      const filter = activeTab ? activeTab.dataset.filter : "todos";

      productCards.forEach((card) => {
        const name = card.dataset.name.toLowerCase();
        const category = card.dataset.category.toLowerCase();
        const matchesSearch = !query || name.includes(query);
        const matchesCategory = filter === "todos" || category === filter;
        card.style.display = matchesSearch && matchesCategory ? "grid" : "none";
      });
    };

    searchInput.addEventListener("input", applyFilters);
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      applyFilters();
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((item) => item.classList.remove("active"));
        tab.classList.add("active");
        applyFilters();
      });
    });

    if (clientSelect && clientRtnInput) {
      clientSelect.addEventListener("change", () => {
        updateClientSelection();
        if (clientSearch) {
          renderClientOptions(clientSearch.value);
        }
      });
    }

    const applyPedidoData = (pedidoData) => {
      if (!pedidoData || !pedidoData.items) {
        return;
      }
      isLoadingPedido = true;
      clearInvoiceRows();
      pedidoData.items.forEach((item) => {
        const card = productMap.get(String(item.producto_id));
        if (!card) {
          return;
        }
        addRow(card, {
          quantity: Number(item.cantidad || 0),
          discount: Number(item.descuento || 0),
          replace: true,
        });
      });
      isLoadingPedido = false;
      currentPedidoId = pedidoData.pedido_id;
      if (pedidoSelect) {
        pedidoSelect.value = String(pedidoData.pedido_id || "");
      }
      if (clientSelect) {
        const option = clientSelect.querySelector(
          `option[value="${pedidoData.cliente_id || ""}"]`
        );
        if (option) {
          clientSelect.value = String(pedidoData.cliente_id);
          updateClientSelection();
          if (clientRtnInput && pedidoData.rtn) {
            clientRtnInput.value = pedidoData.rtn;
          }
        } else if (clientRtnInput) {
          clientRtnInput.value = pedidoData.rtn || "";
        }
      }
      updateTotals();
    };

    if (loadOrderButton && pedidoSelect) {
      loadOrderButton.addEventListener("click", async () => {
        const pedidoId = pedidoSelect.value;
        if (!pedidoId) {
          alert("Selecciona un pedido.");
          return;
        }
        try {
          const response = await fetch(`/pedidos/${pedidoId}/data`);
          const result = await response.json();
          if (!response.ok) {
            alert(result.error || "No se pudo cargar el pedido.");
            return;
          }
          applyPedidoData(result);
        } catch (error) {
          alert("No se pudo cargar el pedido.");
        }
      });
    }

    const getInvoiceType = () => {
      const selected = document.querySelector('input[name="tipo"]:checked');
      return selected ? selected.value : "contado";
    };

    const openInvoiceModal = () => {
      const rows = invoiceTable.querySelectorAll(".invoice-row");
      if (!rows.length) {
        alert("Agrega productos antes de emitir la factura.");
        return;
      }

      const selectedOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
      const clientName = selectedOption && selectedOption.value ? selectedOption.textContent.trim() : "-";
      const rtnValue = clientRtnInput ? clientRtnInput.value.trim() : "";
      if (invoiceClient) {
        invoiceClient.textContent = `Cliente: ${clientName || "-"}`;
      }
      if (invoiceRtn) {
        invoiceRtn.textContent = `RTN: ${rtnValue || "-"}`;
      }
      modalInvoiceType = getInvoiceType();
      if (invoiceType) {
        invoiceType.textContent = `Tipo: ${modalInvoiceType === "credito" ? "Credito" : "Contado"}`;
      }

      let subtotal = 0;
      let isv = 0;
      let exento = 0;
      let gravado = 0;
      let descuento = 0;
      const itemsHtml = Array.from(rows)
        .map((row) => {
          const qty = Number(row.querySelector(".qty-input").value || 0);
          const price = Number(row.dataset.price || 0);
          const line = qty * price;
          const discountUnit = Number(row.querySelector(".discount-input").value || 0);
          const safeDiscountUnit = Math.max(0, Math.min(discountUnit, price));
          const lineNet = Math.max(0, (price - safeDiscountUnit) * qty);
          const applyTax = row.dataset.isv === "1";
          if (applyTax) {
            isv += lineNet * taxRate;
            gravado += lineNet;
          } else {
            exento += lineNet;
          }
          subtotal += line;
          descuento += safeDiscountUnit * qty;
          return `
            <div class="invoice-item">
              <span>${row.querySelector("span").textContent}</span>
              <span>${qty} x ${formatCurrency(price)}</span>
              <strong>${formatCurrency(lineNet)}</strong>
            </div>
          `;
        })
        .join("");

      modalTotalValue = Math.max(0, subtotal - descuento) + isv;
      if (invoiceItems) {
        invoiceItems.innerHTML = itemsHtml;
      }
      if (invoiceSubtotal) {
        invoiceSubtotal.textContent = formatCurrency(subtotal);
      }
      if (invoiceExento) {
        invoiceExento.textContent = formatCurrency(exento);
      }
      if (invoiceGravado) {
        invoiceGravado.textContent = formatCurrency(gravado);
      }
      if (invoiceIsv) {
        invoiceIsv.textContent = formatCurrency(isv);
      }
      if (invoiceDiscount) {
        invoiceDiscount.textContent = formatCurrency(descuento);
      }
      if (invoiceTotal) {
        invoiceTotal.textContent = formatCurrency(modalTotalValue);
      }
      if (invoicePaid) {
        invoicePaid.value = modalInvoiceType === "credito" ? "0.00" : modalTotalValue.toFixed(2);
      }
      if (invoiceChange) {
        invoiceChange.textContent = formatCurrency(0);
      }
      if (invoiceBalanceRow && invoiceBalance) {
        invoiceBalanceRow.style.display = modalInvoiceType === "credito" ? "flex" : "none";
        invoiceBalance.textContent = formatCurrency(
          modalInvoiceType === "credito" ? modalTotalValue : 0
        );
      }
      if (invoiceDateInput && !invoiceDateInput.value) {
        invoiceDateInput.value = toDateInputValue(new Date());
      }

      if (invoiceModal) {
        invoiceModal.classList.add("open");
      }
      if (invoicePdfLink) {
        invoicePdfLink.style.display = "none";
        invoicePdfLink.href = "#";
      }
      if (invoiceWhatsappLink) {
        invoiceWhatsappLink.style.display = "none";
        invoiceWhatsappLink.href = "#";
      }
      if (confirmInvoice) {
        confirmInvoice.style.display = "inline-flex";
      }
    };

    const updateChange = () => {
      if (!invoicePaid || !invoiceChange) {
        return;
      }
      const paid = Number(invoicePaid.value || 0);
      const change = Math.max(0, paid - modalTotalValue);
      if (modalInvoiceType === "credito") {
        invoiceChange.textContent = formatCurrency(0);
        if (invoiceBalance) {
          const balance = Math.max(0, modalTotalValue - paid);
          invoiceBalance.textContent = formatCurrency(balance);
        }
      } else {
        invoiceChange.textContent = formatCurrency(change);
        if (invoiceBalance) {
          invoiceBalance.textContent = formatCurrency(0);
        }
      }
    };

    if (emitButton) {
      emitButton.addEventListener("click", openInvoiceModal);
    }

    invoiceCloseButtons.forEach((button) => {
      button.addEventListener("click", () => {
        if (invoiceModal) {
          invoiceModal.classList.remove("open");
        }
      });
    });

    if (invoiceModal) {
      invoiceModal.addEventListener("click", (event) => {
        if (event.target === invoiceModal) {
          invoiceModal.classList.remove("open");
        }
      });
    }

    if (invoicePaid) {
      invoicePaid.addEventListener("input", updateChange);
    }
    if (confirmInvoice) {
      confirmInvoice.addEventListener("click", async () => {
        const rows = invoiceTable.querySelectorAll(".invoice-row");
        if (!rows.length) {
          alert("Agrega productos antes de emitir la factura.");
          return;
        }
        const selectedOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
        const clienteId = selectedOption && selectedOption.value ? Number(selectedOption.value) : null;
        const rtnValue = clientRtnInput ? clientRtnInput.value.trim() : "";
        const paid = Number(invoicePaid ? invoicePaid.value : 0);
        const tipo = modalInvoiceType;
        const fecha = invoiceDateInput ? invoiceDateInput.value : "";
        if (tipo === "contado" && paid < modalTotalValue) {
          alert("En contado, el pago debe ser igual o mayor al total.");
          return;
        }
        const items = Array.from(rows).map((row) => ({
          producto_id: Number(row.dataset.id),
          cantidad: Number(row.querySelector(".qty-input").value || 0),
          descuento: Number(row.querySelector(".discount-input").value || 0),
        }));

        try {
          const response = await fetch("/facturas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tipo,
              cliente_id: clienteId,
              rtn: rtnValue,
              pago: paid,
              fecha,
              items,
              pedido_id: currentPedidoId,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            alert(result.error || "No se pudo guardar la factura.");
            return;
          }
          alert(`Factura guardada: ${result.numero_factura}`);
          if (confirmInvoice) {
            confirmInvoice.style.display = "none";
          }
          if (result.pdf_url && invoicePdfLink) {
            invoicePdfLink.href = result.pdf_url;
            invoicePdfLink.style.display = "inline-flex";
          }
          if (invoiceWhatsappLink && result.pdf_url) {
            const pdfUrl = new URL(result.pdf_url, window.location.origin).toString();
            const clientName = clientSelect ? clientSelect.options[clientSelect.selectedIndex]?.textContent.trim() : "";
            const greeting = clientName ? `Hola ${clientName},` : "Hola,";
            const tipoText = tipo === "credito" ? "credito" : "contado";
            const message = encodeURIComponent(
              `${greeting}\nSe genero una factura ${tipoText} por L ${modalTotalValue.toFixed(2)}.\nNo. ${result.numero_factura}\nPDF: ${pdfUrl}`
            );
            invoiceWhatsappLink.href = `https://wa.me/?text=${message}`;
            invoiceWhatsappLink.style.display = "inline-flex";
          }
          // Mantener modal abierto para que pueda ver PDF/WhatsApp.
        } catch (error) {
          alert("No se pudo guardar la factura.");
        }
      });
    }

    if (saveOrderButton) {
      saveOrderButton.addEventListener("click", async () => {
        const rows = invoiceTable.querySelectorAll(".invoice-row");
        if (!rows.length) {
          alert("Agrega productos antes de guardar el pedido.");
          return;
        }
        const selectedOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
        const clienteId = selectedOption && selectedOption.value ? Number(selectedOption.value) : null;
        const rtnValue = clientRtnInput ? clientRtnInput.value.trim() : "";
        const items = Array.from(rows).map((row) => ({
          producto_id: Number(row.dataset.id),
          cantidad: Number(row.querySelector(".qty-input").value || 0),
          descuento: Number(row.querySelector(".discount-input").value || 0),
        }));

        try {
          const response = await fetch("/pedidos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cliente_id: clienteId,
              rtn: rtnValue,
              items,
            }),
          });
          const result = await response.json();
          if (!response.ok) {
            alert(result.error || "No se pudo guardar el pedido.");
            return;
          }
          alert(`Pedido guardado: ${result.numero_pedido}`);
          clearInvoiceRows();
          if (clientSelect) {
            clientSelect.value = "";
          }
          if (clientRtnInput) {
            clientRtnInput.value = "";
          }
          clearPedidoContext();
        } catch (error) {
          alert("No se pudo guardar el pedido.");
        }
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const initialPedidoId = urlParams.get("pedido_id");
    if (initialPedidoId) {
      fetch(`/pedidos/${initialPedidoId}/data`)
        .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
          if (!ok) {
            alert(data.error || "No se pudo cargar el pedido.");
            return;
          }
          applyPedidoData(data);
        })
        .catch(() => {
          alert("No se pudo cargar el pedido.");
        });
    }
  </script>
{% endblock %}
